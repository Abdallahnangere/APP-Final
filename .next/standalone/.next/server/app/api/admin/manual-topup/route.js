"use strict";(()=>{var e={};e.id=186,e.ids=[186],e.modules={3524:e=>{e.exports=require("@prisma/client")},517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},9491:e=>{e.exports=require("assert")},6113:e=>{e.exports=require("crypto")},2361:e=>{e.exports=require("events")},7147:e=>{e.exports=require("fs")},3685:e=>{e.exports=require("http")},5158:e=>{e.exports=require("http2")},5687:e=>{e.exports=require("https")},1808:e=>{e.exports=require("net")},2037:e=>{e.exports=require("os")},1017:e=>{e.exports=require("path")},2781:e=>{e.exports=require("stream")},4404:e=>{e.exports=require("tls")},6224:e=>{e.exports=require("tty")},7310:e=>{e.exports=require("url")},3837:e=>{e.exports=require("util")},9796:e=>{e.exports=require("zlib")},5860:(e,t,r)=>{r.r(t),r.d(t,{headerHooks:()=>S,originalPathname:()=>h,patchFetch:()=>O,requestAsyncStorage:()=>d,routeModule:()=>m,serverHooks:()=>A,staticGenerationAsyncStorage:()=>g,staticGenerationBailout:()=>I});var a={};r.r(a),r.d(a,{POST:()=>c});var o=r(5419),s=r(9108),n=r(9678),i=r(8070),l=r(3214),u=r(8272),p=r(313);async function c(e){try{let{phone:t,planId:r,password:a}=await e.json();if(a!==process.env.ADMIN_PASSWORD)return i.Z.json({error:"Unauthorized"},{status:401});let o=await l._.dataPlan.findUnique({where:{id:r}});if(!o)return i.Z.json({error:"Plan not found"},{status:404});let s=p.Vi[o.network],n=`MANUAL-${(0,u.Z)()}`,c={network:s,mobile_number:t,plan:Number(o.planId),Ported_number:!0};console.log("[Manual Topup] Sending to Amigo:",JSON.stringify(c));let m=await (0,p.Ft)("/data/",c,n),d=m.success&&(!0===m.data.success||"successful"===m.data.Status||"delivered"===m.data.status||"successful"===m.data.status),g=await l._.transaction.create({data:{tx_ref:n,type:"data",status:d?"delivered":"failed",phone:t,amount:0,planId:o.id,deliveryData:m.data,paymentData:{method:"Manual Admin Topup"}}});if(!d)return i.Z.json({error:"Tunnel Delivery Failed",details:m.data},{status:400});return i.Z.json({success:!0,transaction:g})}catch(e){return console.error(e),i.Z.json({error:e.message||"Server Error"},{status:500})}}let m=new o.AppRouteRouteModule({definition:{kind:s.x.APP_ROUTE,page:"/api/admin/manual-topup/route",pathname:"/api/admin/manual-topup",filename:"route",bundlePath:"app/api/admin/manual-topup/route"},resolvedPagePath:"/workspaces/APP-Final/app/api/admin/manual-topup/route.ts",nextConfigOutput:"standalone",userland:a}),{requestAsyncStorage:d,staticGenerationAsyncStorage:g,serverHooks:A,headerHooks:S,staticGenerationBailout:I}=m,h="/api/admin/manual-topup/route";function O(){return(0,n.patchFetch)({serverHooks:A,staticGenerationAsyncStorage:g})}},313:(e,t,r)=>{let a;r.d(t,{Vi:()=>g,Ft:()=>d});var o=r(8428),s=r(6489);let n={maxRetries:3,initialDelayMs:1e3,maxDelayMs:3e4,backoffMultiplier:2,shouldRetry:e=>!!(!e||"ECONNREFUSED"===e.code||"ETIMEDOUT"===e.code||e.response?.status>=500)};async function i(e,t={}){let r;let a={...n,...t},o=a.initialDelayMs;for(let t=0;t<=a.maxRetries;t++)try{return await e()}catch(e){if(r=e,t===a.maxRetries)break;if(!a.shouldRetry(e))throw e;await function(e){return new Promise(t=>setTimeout(t,e))}(o),o=Math.min(o*a.backoffMultiplier,a.maxDelayMs)}throw r}var l=r(8216);let u=process.env.AMIGO_BASE_URL||"https://amigo.ng/api/data/",p=process.env.AWS_PROXY_URL,c=process.env.AMIGO_API_KEY||"";if(p)try{a=new s.HttpsProxyAgent(p)}catch(e){console.error("Failed to initialize Proxy Agent",e)}let m=o.Z.create({httpsAgent:a,proxy:!1,headers:{"Content-Type":"application/json",Authorization:`Bearer ${c}`,Token:c,"X-API-Key":c,Accept:"application/json"},timeout:6e4});async function d(e,t,r){l.k.logExternalApiCall("AMIGO",u,"POST",0,0,{hasIdempotencyKey:!!r});try{let e=await i(async()=>{let e={};r&&(e["Idempotency-Key"]=r);let a=Date.now(),o=await m.post(u,t,{headers:e}),s=Date.now()-a;return l.k.logExternalApiCall("AMIGO",u,"POST",o.status,s),{success:!0,data:o.data,status:o.status}},{maxRetries:3,initialDelayMs:1e3,maxDelayMs:1e4,shouldRetry:e=>!!("ECONNREFUSED"===e.code||"ETIMEDOUT"===e.code||e.response?.status>=500)});return console.log(`[Amigo API] ✅ Success: ${e.status}`),e}catch(r){let e=r.response?.data?.message||r.message,t=r.response?.status||500;return l.k.logExternalApiCall("AMIGO",u,"POST",t,0,{error:e,retried:!0}),console.error(`[Amigo API] ❌ Failed: ${e}`),{success:!1,data:r.response?.data||{error:e},status:t}}}let g={MTN:1,GLO:2,AIRTEL:4,"9MOBILE":9}},8216:(e,t,r)=>{var a;r.d(t,{k:()=>s}),function(e){e.DEBUG="DEBUG",e.INFO="INFO",e.WARN="WARN",e.ERROR="ERROR",e.CRITICAL="CRITICAL"}(a||(a={}));class o{formatLog(e){return JSON.stringify({...e,timestamp:new Date().toISOString()})}logApiRequest(e,t,r,a){let o=Date.now(),s=Math.random().toString(36).substr(2,9);return console.log(this.formatLog({timestamp:new Date().toISOString(),level:"INFO",service:e,action:t,userId:r,details:{...a,requestId:s,type:"REQUEST_START"}})),(a,n,i)=>{let l=Date.now()-o;console.log(this.formatLog({timestamp:new Date().toISOString(),level:a>=400?"ERROR":"INFO",service:e,action:t,userId:r,statusCode:a,duration:l,details:{...n,requestId:s,type:"REQUEST_END"},error:i?.message}))}}logTransaction(e,t,r,a,o){console.log(this.formatLog({timestamp:new Date().toISOString(),level:"SUCCESS"===a?"INFO":"WARN",service:"TRANSACTION",action:t,userId:e,details:{amount:r,status:a,...o}}))}logAuth(e,t,r,a){console.log(this.formatLog({timestamp:new Date().toISOString(),level:r?"INFO":"WARN",service:"AUTH",action:e,userId:t,details:{success:r,...a}}))}logSecurityEvent(e,t){console.log(this.formatLog({timestamp:new Date().toISOString(),level:"WARN",service:"SECURITY",action:e,details:t}))}logError(e,t,r,a){console.error(this.formatLog({timestamp:new Date().toISOString(),level:"ERROR",service:e,action:t,error:r.message,details:a}))}logCritical(e,t,r){console.error(this.formatLog({timestamp:new Date().toISOString(),level:"CRITICAL",service:"SYSTEM",action:e,error:t.message,details:r}))}logWebhook(e,t,r,a){console.log(this.formatLog({timestamp:new Date().toISOString(),level:"INFO",service:"WEBHOOK",action:e,details:{transactionId:t,status:r,...a}}))}logExternalApiCall(e,t,r,a,o,s){console.log(this.formatLog({timestamp:new Date().toISOString(),level:a>=400?"WARN":"DEBUG",service:`EXTERNAL_API_${e}`,action:`${r} ${t}`,statusCode:a,duration:o,details:s}))}logDatabaseOperation(e,t,r,a,o){console.log(this.formatLog({timestamp:new Date().toISOString(),level:a?"DEBUG":"ERROR",service:"DATABASE",action:`${e}_${t}`,duration:r,details:{success:a,...o}}))}}let s=new o},3214:(e,t,r)=>{r.d(t,{_:()=>o});var a=r(3524);let o=globalThis.prisma||new a.PrismaClient({log:["query","error","warn"]})},8272:(e,t,r)=>{r.d(t,{Z:()=>u});var a=r(6113),o=r.n(a);let s={randomUUID:o().randomUUID},n=new Uint8Array(256),i=n.length,l=[];for(let e=0;e<256;++e)l.push((e+256).toString(16).slice(1));let u=function(e,t,r){if(s.randomUUID&&!t&&!e)return s.randomUUID();let a=(e=e||{}).random||(e.rng||function(){return i>n.length-16&&(o().randomFillSync(n),i=0),n.slice(i,i+=16)})();if(a[6]=15&a[6]|64,a[8]=63&a[8]|128,t){r=r||0;for(let e=0;e<16;++e)t[r+e]=a[e];return t}return function(e,t=0){return l[e[t+0]]+l[e[t+1]]+l[e[t+2]]+l[e[t+3]]+"-"+l[e[t+4]]+l[e[t+5]]+"-"+l[e[t+6]]+l[e[t+7]]+"-"+l[e[t+8]]+l[e[t+9]]+"-"+l[e[t+10]]+l[e[t+11]]+l[e[t+12]]+l[e[t+13]]+l[e[t+14]]+l[e[t+15]]}(a)}}};var t=require("../../../../webpack-runtime.js");t.C(e);var r=e=>t(t.s=e),a=t.X(0,[1638,6206,7901,8428,6489],()=>r(5860));module.exports=a})();