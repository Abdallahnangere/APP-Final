"use strict";(()=>{var e={};e.id=108,e.ids=[108],e.modules={3524:e=>{e.exports=require("@prisma/client")},517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},9491:e=>{e.exports=require("assert")},6113:e=>{e.exports=require("crypto")},2361:e=>{e.exports=require("events")},7147:e=>{e.exports=require("fs")},3685:e=>{e.exports=require("http")},5158:e=>{e.exports=require("http2")},5687:e=>{e.exports=require("https")},2037:e=>{e.exports=require("os")},1017:e=>{e.exports=require("path")},2781:e=>{e.exports=require("stream")},6224:e=>{e.exports=require("tty")},7310:e=>{e.exports=require("url")},3837:e=>{e.exports=require("util")},9796:e=>{e.exports=require("zlib")},1839:(e,t,r)=>{r.r(t),r.d(t,{headerHooks:()=>_,originalPathname:()=>R,patchFetch:()=>S,requestAsyncStorage:()=>E,routeModule:()=>I,serverHooks:()=>v,staticGenerationAsyncStorage:()=>h,staticGenerationBailout:()=>f});var a={};r.r(a),r.d(a,{POST:()=>g,dynamic:()=>d});var n=r(5419),o=r(9108),i=r(9678),s=r(8070),l=r(3214),m=r(8428),u=r(8272),p=r(9856),c=r(8216);let d="force-dynamic";async function g(e){let t="",r=c.k.logApiRequest("ECOMMERCE","INITIATE_PAYMENT");try{let a=await e.json(),n=await (0,p.sQ)(a,p.ZB);if(!n.valid){let e=n.errors.errors.map(e=>`${e.path.join(".")}: ${e.message}`);return c.k.logSecurityEvent("INVALID_REQUEST",{service:"ECOMMERCE_PAYMENT",errors:e}),r(400,null,Error("Validation failed")),s.Z.json({error:"Validation failed",details:e},{status:400})}let{productId:o,phone:i,name:d,state:g,simId:I}=n.data;if(!i||i.length<10)return c.k.logSecurityEvent("INVALID_REQUEST",{phone:i,reason:"Invalid phone format"}),r(400,null,Error("Invalid phone number")),s.Z.json({error:"Invalid phone number"},{status:400});if(t=i,!process.env.FLUTTERWAVE_SECRET_KEY)return c.k.logCritical("ECOMMERCE",Error("Missing Flutterwave key"),{}),r(500,null,Error("Server configuration error")),s.Z.json({error:"Server configuration error"},{status:500});let E=await l._.product.findUnique({where:{id:o}});if(!E)return c.k.logSecurityEvent("INVALID_REQUEST",{phone:t,reason:"Product not found",productId:o}),r(404,null,Error("Product not found")),s.Z.json({error:"Product not found"},{status:404});let h=E.price,v=[{name:E.name,price:E.price}],_=[E.name];if(I){let e=await l._.product.findUnique({where:{id:I}});e&&(h+=e.price,v.push({name:e.name,price:e.price}),_.push(e.name))}let f=_.join(" + "),R=`SAUKI-COM-${Date.now()}-${Math.floor(1e3*Math.random())}`,S={tx_ref:R,amount:String(h),email:"saukidatalinks@gmail.com",phone_number:t,currency:"NGN",fullname:d,narration:`SAUKI ${f.substring(0,20)}`,is_permanent:!1,meta:{consumer_id:t,consumer_mac:"kgh94"}};try{let e=(await m.Z.post("https://api.flutterwave.com/v3/charges?type=bank_transfer",S,{headers:{Authorization:`Bearer ${process.env.FLUTTERWAVE_SECRET_KEY}`,"Content-Type":"application/json"}})).data;if("success"!==e.status)throw console.error("FLW Error:",e),Error(e.message||"Payment initialization failed");let a=e.meta||e.data?.meta,n=a?.authorization;if(!n||!n.transfer_bank||!n.transfer_account)throw Error("Gateway returned incomplete bank details.");return await l._.transaction.create({data:{tx_ref:R,type:"ecommerce",status:"pending",phone:t,amount:h,productId:o,customerName:d,deliveryState:g,idempotencyKey:(0,u.Z)(),paymentData:e,deliveryData:{manifest:f,items:v,address:g,initiatedAt:new Date().toISOString()}}}),c.k.logTransaction(t,"ECOMMERCE_INITIATED",h,"PENDING",{tx_ref:R,items:v.length,manifest:f}),r(200,{tx_ref:R,amount:h}),s.Z.json({tx_ref:R,bank:n.transfer_bank,account_number:n.transfer_account,account_name:"SAUKI MART FLW",amount:h,note:n.transfer_note})}catch(a){c.k.logError("PAYMENT","FLW_GATEWAY",a,{phone:t,amount:h});let e=a.response?.data?.message||a.message;return r(502,null,a),s.Z.json({error:"Gateway Error",details:e},{status:502})}}catch(e){return c.k.logError("ECOMMERCE","INITIATE_PAYMENT",e,{phone:t}),r(500,null,e),s.Z.json({error:e.message||"Initiation failed"},{status:500})}}let I=new n.AppRouteRouteModule({definition:{kind:o.x.APP_ROUTE,page:"/api/ecommerce/initiate-payment/route",pathname:"/api/ecommerce/initiate-payment",filename:"route",bundlePath:"app/api/ecommerce/initiate-payment/route"},resolvedPagePath:"/workspaces/APP-Final/app/api/ecommerce/initiate-payment/route.ts",nextConfigOutput:"standalone",userland:a}),{requestAsyncStorage:E,staticGenerationAsyncStorage:h,serverHooks:v,headerHooks:_,staticGenerationBailout:f}=I,R="/api/ecommerce/initiate-payment/route";function S(){return(0,i.patchFetch)({serverHooks:v,staticGenerationAsyncStorage:h})}},8216:(e,t,r)=>{var a;r.d(t,{k:()=>o}),function(e){e.DEBUG="DEBUG",e.INFO="INFO",e.WARN="WARN",e.ERROR="ERROR",e.CRITICAL="CRITICAL"}(a||(a={}));class n{formatLog(e){return JSON.stringify({...e,timestamp:new Date().toISOString()})}logApiRequest(e,t,r,a){let n=Date.now(),o=Math.random().toString(36).substr(2,9);return console.log(this.formatLog({timestamp:new Date().toISOString(),level:"INFO",service:e,action:t,userId:r,details:{...a,requestId:o,type:"REQUEST_START"}})),(a,i,s)=>{let l=Date.now()-n;console.log(this.formatLog({timestamp:new Date().toISOString(),level:a>=400?"ERROR":"INFO",service:e,action:t,userId:r,statusCode:a,duration:l,details:{...i,requestId:o,type:"REQUEST_END"},error:s?.message}))}}logTransaction(e,t,r,a,n){console.log(this.formatLog({timestamp:new Date().toISOString(),level:"SUCCESS"===a?"INFO":"WARN",service:"TRANSACTION",action:t,userId:e,details:{amount:r,status:a,...n}}))}logAuth(e,t,r,a){console.log(this.formatLog({timestamp:new Date().toISOString(),level:r?"INFO":"WARN",service:"AUTH",action:e,userId:t,details:{success:r,...a}}))}logSecurityEvent(e,t){console.log(this.formatLog({timestamp:new Date().toISOString(),level:"WARN",service:"SECURITY",action:e,details:t}))}logError(e,t,r,a){console.error(this.formatLog({timestamp:new Date().toISOString(),level:"ERROR",service:e,action:t,error:r.message,details:a}))}logCritical(e,t,r){console.error(this.formatLog({timestamp:new Date().toISOString(),level:"CRITICAL",service:"SYSTEM",action:e,error:t.message,details:r}))}logWebhook(e,t,r,a){console.log(this.formatLog({timestamp:new Date().toISOString(),level:"INFO",service:"WEBHOOK",action:e,details:{transactionId:t,status:r,...a}}))}logExternalApiCall(e,t,r,a,n,o){console.log(this.formatLog({timestamp:new Date().toISOString(),level:a>=400?"WARN":"DEBUG",service:`EXTERNAL_API_${e}`,action:`${r} ${t}`,statusCode:a,duration:n,details:o}))}logDatabaseOperation(e,t,r,a,n){console.log(this.formatLog({timestamp:new Date().toISOString(),level:a?"DEBUG":"ERROR",service:"DATABASE",action:`${e}_${t}`,duration:r,details:{success:a,...n}}))}}let o=new n},3214:(e,t,r)=>{r.d(t,{_:()=>n});var a=r(3524);let n=globalThis.prisma||new a.PrismaClient({log:["query","error","warn"]})},9856:(e,t,r)=>{r.d(t,{A0:()=>o,Td:()=>l,ZB:()=>s,g1:()=>i,sQ:()=>m});var a=r(5252),n=r(2178);let o=a.Ry({firstName:a.Z_().min(2,"First name must be at least 2 characters").max(50),lastName:a.Z_().min(2,"Last name must be at least 2 characters").max(50),phone:a.Z_().regex(/^[0-9]{10,11}$/,"Invalid phone number"),pin:a.Z_().regex(/^[0-9]{4}$/,"PIN must be exactly 4 digits")}),i=a.Ry({phone:a.Z_().regex(/^[0-9]{10,11}$/,"Invalid phone number"),pin:a.Z_().regex(/^[0-9]{4}$/,"PIN must be exactly 4 digits")});a.Ry({tx_ref:a.Z_().min(1,"Transaction reference required")});let s=a.Ry({productId:a.Z_().min(1,"Product ID required"),phone:a.Z_().regex(/^[0-9]{10,11}$/,"Invalid phone number"),name:a.Z_().min(2,"Name required").max(100),state:a.Z_().min(2,"State required").max(100),simId:a.Z_().optional()});a.Ry({phone:a.Z_().regex(/^[0-9]{10,11}$/,"Invalid phone number"),network:a.Km(["MTN","AIRTEL","GLO"]),planId:a.Rx().positive("Invalid plan ID"),agentId:a.Z_().uuid("Invalid agent ID").optional(),agentPin:a.Z_().regex(/^[0-9]{4}$/,"PIN must be exactly 4 digits").optional()}),a.Ry({amount:a.Rx().positive("Amount must be positive"),phone:a.Z_().regex(/^[0-9]{10,11}$/,"Invalid phone number"),agentId:a.Z_().uuid("Invalid agent ID"),agentPin:a.Z_().regex(/^[0-9]{4}$/,"PIN must be exactly 4 digits")});let l=a.Ry({agentId:a.Z_().uuid("Invalid agent ID"),agentPin:a.Z_().regex(/^[0-9]{4}$/,"PIN must be exactly 4 digits"),type:a.Km(["data","ecommerce"]),payload:a.Ry({planId:a.Z_().optional(),productId:a.Z_().optional(),simId:a.Z_().optional(),phone:a.Z_().regex(/^[0-9]{10,11}$/,"Invalid phone number").optional(),name:a.Z_().min(2).max(100).optional(),state:a.Z_().min(2).max(100).optional()}).strict()});a.Ry({phone:a.Z_().regex(/^[0-9]{10,11}$/,"Invalid phone number"),message:a.Z_().min(10,"Message must be at least 10 characters").max(1e3),subject:a.Z_().optional()}),a.Ry({adminPassword:a.Z_().min(6,"Invalid password")}),a.Ry({agentId:a.Z_().uuid("Invalid agent ID"),amount:a.Rx().positive("Amount must be positive"),reason:a.Z_().optional(),adminPassword:a.Z_().min(6,"Invalid password")});let m=async(e,t)=>{try{let r=await t.parseAsync(e);return{valid:!0,data:r}}catch(e){if(e instanceof n.jm)return{valid:!1,errors:e};throw e}}},8272:(e,t,r)=>{r.d(t,{Z:()=>m});var a=r(6113),n=r.n(a);let o={randomUUID:n().randomUUID},i=new Uint8Array(256),s=i.length,l=[];for(let e=0;e<256;++e)l.push((e+256).toString(16).slice(1));let m=function(e,t,r){if(o.randomUUID&&!t&&!e)return o.randomUUID();let a=(e=e||{}).random||(e.rng||function(){return s>i.length-16&&(n().randomFillSync(i),s=0),i.slice(s,s+=16)})();if(a[6]=15&a[6]|64,a[8]=63&a[8]|128,t){r=r||0;for(let e=0;e<16;++e)t[r+e]=a[e];return t}return function(e,t=0){return l[e[t+0]]+l[e[t+1]]+l[e[t+2]]+l[e[t+3]]+"-"+l[e[t+4]]+l[e[t+5]]+"-"+l[e[t+6]]+l[e[t+7]]+"-"+l[e[t+8]]+l[e[t+9]]+"-"+l[e[t+10]]+l[e[t+11]]+l[e[t+12]]+l[e[t+13]]+l[e[t+14]]+l[e[t+15]]}(a)}}};var t=require("../../../../webpack-runtime.js");t.C(e);var r=e=>t(t.s=e),a=t.X(0,[1638,6206,7901,8428,5252],()=>r(1839));module.exports=a})();