"use strict";(()=>{var e={};e.id=8238,e.ids=[8238],e.modules={3524:e=>{e.exports=require("@prisma/client")},517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},6113:e=>{e.exports=require("crypto")},2069:(e,t,r)=>{r.r(t),r.d(t,{headerHooks:()=>R,originalPathname:()=>A,patchFetch:()=>_,requestAsyncStorage:()=>p,routeModule:()=>I,serverHooks:()=>v,staticGenerationAsyncStorage:()=>h,staticGenerationBailout:()=>S});var a={};r.r(a),r.d(a,{POST:()=>d});var n=r(5419),o=r(9108),i=r(9678),s=r(8070),l=r(3214),g=r(2156),m=r(9856),u=r(8216),c=r(951);async function d(e){let t="",r=u.k.logApiRequest("AUTH","AGENT_LOGIN");try{let a=await e.json(),n=await (0,m.sQ)(a,m.g1);if(!n.valid){let e=n.errors.errors.map(e=>`${e.path.join(".")}: ${e.message}`);return u.k.logSecurityEvent("INVALID_REQUEST",{service:"LOGIN",errors:e}),r(400,{error:"Validation failed"}),s.Z.json({error:"Validation failed",details:e},{status:400})}let{phone:o,pin:i}=n.data;if(t=o,!c.Wq.check(t)){let e=c.Wq.getInfo(t);return u.k.logSecurityEvent("RATE_LIMITED",{phone:t,resetTime:e.resetTime}),r(429,{error:"Too many attempts"}),s.Z.json({error:"Too many login attempts. Please try again later."},{status:429,headers:{"Retry-After":String(Math.ceil((e.resetTime-Date.now())/1e3))}})}let d=await l._.agent.findUnique({where:{phone:t}});if(!d)return u.k.logAuth("LOGIN",t,!1,{reason:"Agent not found"}),u.k.logSecurityEvent("INVALID_REQUEST",{phone:t,reason:"No such agent"}),r(401,{error:"Invalid credentials"}),s.Z.json({error:"Invalid Phone or PIN"},{status:401});if(!await (0,g.vj)(i,d.pin))return u.k.logAuth("LOGIN",t,!1,{reason:"Invalid PIN"}),u.k.logSecurityEvent("INVALID_REQUEST",{phone:t,reason:"PIN mismatch"}),r(401,{error:"Invalid PIN"}),s.Z.json({error:"Invalid Phone or PIN"},{status:401});return c.Wq.reset(t),u.k.logAuth("LOGIN",t,!0),r(200,{agentId:d.id,success:!0}),s.Z.json({success:!0,agent:d})}catch(e){return u.k.logError("AUTH","AGENT_LOGIN",e,{phone:t}),r(500,{error:"Internal error"}),s.Z.json({error:"Login failed"},{status:500})}}let I=new n.AppRouteRouteModule({definition:{kind:o.x.APP_ROUTE,page:"/api/agent/login/route",pathname:"/api/agent/login",filename:"route",bundlePath:"app/api/agent/login/route"},resolvedPagePath:"/workspaces/APP-Final/app/api/agent/login/route.ts",nextConfigOutput:"standalone",userland:a}),{requestAsyncStorage:p,staticGenerationAsyncStorage:h,serverHooks:v,headerHooks:R,staticGenerationBailout:S}=I,A="/api/agent/login/route";function _(){return(0,i.patchFetch)({serverHooks:v,staticGenerationAsyncStorage:h})}},8216:(e,t,r)=>{var a;r.d(t,{k:()=>o}),function(e){e.DEBUG="DEBUG",e.INFO="INFO",e.WARN="WARN",e.ERROR="ERROR",e.CRITICAL="CRITICAL"}(a||(a={}));class n{formatLog(e){return JSON.stringify({...e,timestamp:new Date().toISOString()})}logApiRequest(e,t,r,a){let n=Date.now(),o=Math.random().toString(36).substr(2,9);return console.log(this.formatLog({timestamp:new Date().toISOString(),level:"INFO",service:e,action:t,userId:r,details:{...a,requestId:o,type:"REQUEST_START"}})),(a,i,s)=>{let l=Date.now()-n;console.log(this.formatLog({timestamp:new Date().toISOString(),level:a>=400?"ERROR":"INFO",service:e,action:t,userId:r,statusCode:a,duration:l,details:{...i,requestId:o,type:"REQUEST_END"},error:s?.message}))}}logTransaction(e,t,r,a,n){console.log(this.formatLog({timestamp:new Date().toISOString(),level:"SUCCESS"===a?"INFO":"WARN",service:"TRANSACTION",action:t,userId:e,details:{amount:r,status:a,...n}}))}logAuth(e,t,r,a){console.log(this.formatLog({timestamp:new Date().toISOString(),level:r?"INFO":"WARN",service:"AUTH",action:e,userId:t,details:{success:r,...a}}))}logSecurityEvent(e,t){console.log(this.formatLog({timestamp:new Date().toISOString(),level:"WARN",service:"SECURITY",action:e,details:t}))}logError(e,t,r,a){console.error(this.formatLog({timestamp:new Date().toISOString(),level:"ERROR",service:e,action:t,error:r.message,details:a}))}logCritical(e,t,r){console.error(this.formatLog({timestamp:new Date().toISOString(),level:"CRITICAL",service:"SYSTEM",action:e,error:t.message,details:r}))}logWebhook(e,t,r,a){console.log(this.formatLog({timestamp:new Date().toISOString(),level:"INFO",service:"WEBHOOK",action:e,details:{transactionId:t,status:r,...a}}))}logExternalApiCall(e,t,r,a,n,o){console.log(this.formatLog({timestamp:new Date().toISOString(),level:a>=400?"WARN":"DEBUG",service:`EXTERNAL_API_${e}`,action:`${r} ${t}`,statusCode:a,duration:n,details:o}))}logDatabaseOperation(e,t,r,a,n){console.log(this.formatLog({timestamp:new Date().toISOString(),level:a?"DEBUG":"ERROR",service:"DATABASE",action:`${e}_${t}`,duration:r,details:{success:a,...n}}))}}let o=new n},3214:(e,t,r)=>{r.d(t,{_:()=>n});var a=r(3524);let n=globalThis.prisma||new a.PrismaClient({log:["query","error","warn"]})},951:(e,t,r)=>{r.d(t,{Wq:()=>o,XK:()=>i});class a{isAllowed(e,t=5,r=9e5){let a=Date.now(),n=this.limits.get(e);return!n||a>n.resetTime?(this.limits.set(e,{count:1,resetTime:a+r}),!0):!(n.count>=t)&&(n.count++,!0)}getRemaining(e,t=5,r=9e5){let a=Date.now(),n=this.limits.get(e);return!n||a>n.resetTime?t:Math.max(0,t-n.count)}reset(e){this.limits.delete(e)}clear(){this.limits.clear()}getInfo(e,t=5,r=9e5){let a=Date.now(),n=this.limits.get(e);return!n||a>n.resetTime?{count:0,remaining:t,resetTime:a+r,isLimited:!1}:{count:n.count,remaining:Math.max(0,t-n.count),resetTime:n.resetTime,isLimited:n.count>=t}}constructor(){this.limits=new Map}}let n=new a,o={check:e=>n.isAllowed(`login:${e}`,5,9e5),getInfo:e=>n.getInfo(`login:${e}`,5,9e5),reset:e=>n.reset(`login:${e}`)},i={check:e=>n.isAllowed(`register:${e}`,3,36e5),getInfo:e=>n.getInfo(`register:${e}`,3,36e5),reset:e=>n.reset(`register:${e}`)}},2156:(e,t,r)=>{r.d(t,{vj:()=>o,xM:()=>n});var a=r(5050);async function n(e){try{let t=await a.ZP.genSalt(10);return await a.ZP.hash(e,t)}catch(e){throw console.error("Error hashing PIN:",e),Error("Failed to hash PIN")}}async function o(e,t){try{return await a.ZP.compare(e,t)}catch(e){return console.error("Error verifying PIN:",e),!1}}},9856:(e,t,r)=>{r.d(t,{A0:()=>o,Td:()=>l,ZB:()=>s,g1:()=>i,sQ:()=>g});var a=r(5252),n=r(2178);let o=a.Ry({firstName:a.Z_().min(2,"First name must be at least 2 characters").max(50),lastName:a.Z_().min(2,"Last name must be at least 2 characters").max(50),phone:a.Z_().regex(/^[0-9]{10,11}$/,"Invalid phone number"),pin:a.Z_().regex(/^[0-9]{4}$/,"PIN must be exactly 4 digits")}),i=a.Ry({phone:a.Z_().regex(/^[0-9]{10,11}$/,"Invalid phone number"),pin:a.Z_().regex(/^[0-9]{4}$/,"PIN must be exactly 4 digits")});a.Ry({tx_ref:a.Z_().min(1,"Transaction reference required")});let s=a.Ry({productId:a.Z_().uuid("Invalid product ID"),phone:a.Z_().regex(/^[0-9]{10,11}$/,"Invalid phone number"),name:a.Z_().min(2,"Name required").max(100),state:a.Z_().min(2,"State required").max(100),simId:a.Z_().uuid("Invalid SIM ID").optional()});a.Ry({phone:a.Z_().regex(/^[0-9]{10,11}$/,"Invalid phone number"),network:a.Km(["MTN","AIRTEL","GLO"]),planId:a.Rx().positive("Invalid plan ID"),agentId:a.Z_().uuid("Invalid agent ID").optional(),agentPin:a.Z_().regex(/^[0-9]{4}$/,"PIN must be exactly 4 digits").optional()}),a.Ry({amount:a.Rx().positive("Amount must be positive"),phone:a.Z_().regex(/^[0-9]{10,11}$/,"Invalid phone number"),agentId:a.Z_().uuid("Invalid agent ID"),agentPin:a.Z_().regex(/^[0-9]{4}$/,"PIN must be exactly 4 digits")});let l=a.Ry({agentId:a.Z_().uuid("Invalid agent ID"),agentPin:a.Z_().regex(/^[0-9]{4}$/,"PIN must be exactly 4 digits"),type:a.Km(["data","ecommerce"]),payload:a.Ry({planId:a.Z_().optional(),productId:a.Z_().optional(),simId:a.Z_().optional(),phone:a.Z_().optional(),name:a.Z_().optional(),state:a.Z_().optional()})});a.Ry({phone:a.Z_().regex(/^[0-9]{10,11}$/,"Invalid phone number"),message:a.Z_().min(10,"Message must be at least 10 characters").max(1e3),subject:a.Z_().optional()}),a.Ry({adminPassword:a.Z_().min(6,"Invalid password")}),a.Ry({agentId:a.Z_().uuid("Invalid agent ID"),amount:a.Rx().positive("Amount must be positive"),reason:a.Z_().optional(),adminPassword:a.Z_().min(6,"Invalid password")});let g=async(e,t)=>{try{let r=await t.parseAsync(e);return{valid:!0,data:r}}catch(e){if(e instanceof n.jm)return{valid:!1,errors:e};throw e}}}};var t=require("../../../../webpack-runtime.js");t.C(e);var r=e=>t(t.s=e),a=t.X(0,[1638,6206,5252,7529],()=>r(2069));module.exports=a})();