"use strict";(()=>{var e={};e.id=8101,e.ids=[8101],e.modules={3524:e=>{e.exports=require("@prisma/client")},517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},6113:e=>{e.exports=require("crypto")},3003:(e,a,t)=>{t.r(a),t.d(a,{headerHooks:()=>f,originalPathname:()=>g,patchFetch:()=>w,requestAsyncStorage:()=>p,routeModule:()=>m,serverHooks:()=>b,staticGenerationAsyncStorage:()=>h,staticGenerationBailout:()=>k});var r={};t.r(r),t.d(r,{POST:()=>u,dynamic:()=>l});var n=t(5419),s=t(9108),c=t(9678),i=t(8070),o=t(3214),d=t(8272);let l="force-dynamic";async function u(e){try{let{agentId:a,amount:t}=await e.json();if(!a||!t||t<=0)return i.Z.json({error:"Invalid agent ID or amount"},{status:400});let r=await o._.agent.findUnique({where:{id:a}});if(!r)return i.Z.json({error:"Agent not found"},{status:404});let n=r.cashbackBalance||0;if(t>n)return i.Z.json({error:"Insufficient cashback balance",available:n},{status:402});let s=await o._.$transaction(async e=>{let s=await e.agent.update({where:{id:a},data:{balance:{increment:t},cashbackBalance:{decrement:t},cashbackRedeemed:{increment:t}}}),c=await e.transaction.create({data:{tx_ref:`REDEEM-${Date.now()}-${(0,d.Z)()}`,type:"cashback_redemption",status:"paid",amount:t,agentId:a,customerName:`${r.firstName} ${r.lastName}`,phone:r.phone,deliveryState:"Wallet Transfer",idempotencyKey:(0,d.Z)(),deliveryData:{method:"Instant Wallet Transfer",manifest:`Cashback redeemed: ${t}`,description:"Cashback redemption to main wallet",previousCashbackBalance:n,newCashbackBalance:n-t,newMainBalance:(r.balance||0)+t}}});return await e.cashbackEntry.create({data:{agentId:a,type:"redeemed",amount:t,transactionId:c.id,description:`Redeemed ₦${t} to main wallet`}}),s});return i.Z.json({success:!0,message:`₦${t} redeemed successfully`,agent:{id:s.id,balance:s.balance,cashbackBalance:s.cashbackBalance,cashbackRedeemed:s.cashbackRedeemed}})}catch(e){return console.error("Cashback Redemption Error:",e),i.Z.json({error:e.message||"Redemption failed"},{status:500})}}let m=new n.AppRouteRouteModule({definition:{kind:s.x.APP_ROUTE,page:"/api/agent/redeem-cashback/route",pathname:"/api/agent/redeem-cashback",filename:"route",bundlePath:"app/api/agent/redeem-cashback/route"},resolvedPagePath:"/workspaces/APP-Final/app/api/agent/redeem-cashback/route.ts",nextConfigOutput:"standalone",userland:r}),{requestAsyncStorage:p,staticGenerationAsyncStorage:h,serverHooks:b,headerHooks:f,staticGenerationBailout:k}=m,g="/api/agent/redeem-cashback/route";function w(){return(0,c.patchFetch)({serverHooks:b,staticGenerationAsyncStorage:h})}},3214:(e,a,t)=>{t.d(a,{_:()=>n});var r=t(3524);let n=globalThis.prisma||new r.PrismaClient({log:["query","error","warn"]})},8272:(e,a,t)=>{t.d(a,{Z:()=>d});var r=t(6113),n=t.n(r);let s={randomUUID:n().randomUUID},c=new Uint8Array(256),i=c.length,o=[];for(let e=0;e<256;++e)o.push((e+256).toString(16).slice(1));let d=function(e,a,t){if(s.randomUUID&&!a&&!e)return s.randomUUID();let r=(e=e||{}).random||(e.rng||function(){return i>c.length-16&&(n().randomFillSync(c),i=0),c.slice(i,i+=16)})();if(r[6]=15&r[6]|64,r[8]=63&r[8]|128,a){t=t||0;for(let e=0;e<16;++e)a[t+e]=r[e];return a}return function(e,a=0){return o[e[a+0]]+o[e[a+1]]+o[e[a+2]]+o[e[a+3]]+"-"+o[e[a+4]]+o[e[a+5]]+"-"+o[e[a+6]]+o[e[a+7]]+"-"+o[e[a+8]]+o[e[a+9]]+"-"+o[e[a+10]]+o[e[a+11]]+o[e[a+12]]+o[e[a+13]]+o[e[a+14]]+o[e[a+15]]}(r)}}};var a=require("../../../../webpack-runtime.js");a.C(e);var t=e=>a(a.s=e),r=a.X(0,[1638,6206],()=>t(3003));module.exports=r})();