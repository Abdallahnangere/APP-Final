(()=>{var e={};e.id=2916,e.ids=[2916],e.modules={3524:e=>{"use strict";e.exports=require("@prisma/client")},517:e=>{"use strict";e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},9491:e=>{"use strict";e.exports=require("assert")},6113:e=>{"use strict";e.exports=require("crypto")},2361:e=>{"use strict";e.exports=require("events")},7147:e=>{"use strict";e.exports=require("fs")},3685:e=>{"use strict";e.exports=require("http")},5158:e=>{"use strict";e.exports=require("http2")},5687:e=>{"use strict";e.exports=require("https")},1017:e=>{"use strict";e.exports=require("path")},2781:e=>{"use strict";e.exports=require("stream")},6224:e=>{"use strict";e.exports=require("tty")},7310:e=>{"use strict";e.exports=require("url")},3837:e=>{"use strict";e.exports=require("util")},9796:e=>{"use strict";e.exports=require("zlib")},7529:()=>{},5697:(e,t,r)=>{"use strict";r.r(t),r.d(t,{headerHooks:()=>_,originalPathname:()=>f,patchFetch:()=>T,requestAsyncStorage:()=>R,routeModule:()=>h,serverHooks:()=>v,staticGenerationAsyncStorage:()=>E,staticGenerationBailout:()=>S});var a={};r.r(a),r.d(a,{POST:()=>I});var i=r(5419),n=r(9108),s=r(9678),o=r(8070),l=r(3214),u=r(8428),c=r(8272),m=r(2156),g=r(9856),d=r(8216),p=r(951);async function I(e){let t="",r=d.k.logApiRequest("AUTH","AGENT_REGISTER");try{let a;let i=await e.json(),n=await (0,g.sQ)(i,g.A0);if(!n.valid){let e=n.errors.errors.map(e=>`${e.path.join(".")}: ${e.message}`);return d.k.logSecurityEvent("INVALID_REQUEST",{service:"REGISTER",errors:e}),r(400,{error:"Validation failed"}),o.Z.json({error:"Validation failed",details:e},{status:400})}let{firstName:s,lastName:I,phone:h,pin:R}=n.data;if(t=h,!p.XK.check(t)){let e=p.XK.getInfo(t);return d.k.logSecurityEvent("RATE_LIMITED",{phone:t,action:"REGISTER",resetTime:e.resetTime}),r(429,{error:"Too many registration attempts"}),o.Z.json({error:"Too many registration attempts. Please try again later."},{status:429,headers:{"Retry-After":String(Math.ceil((e.resetTime-Date.now())/1e3))}})}if(await l._.agent.findUnique({where:{phone:t}}))return d.k.logAuth("REGISTER",t,!1,{reason:"Phone already registered"}),r(400,{error:"Agent already exists"}),o.Z.json({error:"Agent with this phone number already exists"},{status:400});try{a=await (0,m.xM)(R)}catch(e){return d.k.logError("SECURITY","PIN_HASHING",e,{phone:t}),r(500,{error:"Hash failed"}),o.Z.json({error:"Failed to process registration"},{status:500})}let E=`AGENT-REG-${(0,c.Z)()}`,v=`agent.${t}@www.saukimart.online`,_=process.env.MY_BVN;if(!process.env.FLUTTERWAVE_SECRET_KEY||!_)return d.k.logCritical("AGENT_REGISTER",Error("Missing server configuration"),{phone:t}),r(500,{error:"Server misconfiguration"}),o.Z.json({error:"Server misconfiguration: Missing Keys"},{status:500});let S={account_number:"",bank_name:"",account_name:""};try{let e=await u.Z.post("https://api.flutterwave.com/v3/virtual-account-numbers",{email:v,is_permanent:!0,bvn:_,tx_ref:E,phonenumber:t,firstname:s,lastname:`${I} Sauki Mart FLW`,narration:`Sauki Agent ${s}`},{headers:{Authorization:`Bearer ${process.env.FLUTTERWAVE_SECRET_KEY}`,"Content-Type":"application/json"}});if("success"===e.data.status)S={account_number:e.data.data.account_number,bank_name:e.data.data.bank_name,account_name:`${s} ${I} Sauki Mart FLW`};else throw Error(e.data.message)}catch(e){return d.k.logError("PAYMENT","FLW_ACCOUNT_CREATION",e,{phone:t}),r(502,{error:"FLW failed"}),o.Z.json({error:"Failed to provision banking wallet. Please try again later."},{status:502})}let f=await l._.agent.create({data:{firstName:s,lastName:I,phone:t,pin:a,flwAccountNumber:S.account_number,flwBankName:S.bank_name,flwAccountName:S.account_name,balance:0}});return d.k.logAuth("REGISTER",t,!0),r(200,{agentId:f.id,success:!0}),o.Z.json({success:!0,agent:f})}catch(e){return d.k.logError("AUTH","AGENT_REGISTER",e,{phone:t}),r(500,{error:"Registration failed"}),o.Z.json({error:"Registration failed"},{status:500})}}let h=new i.AppRouteRouteModule({definition:{kind:n.x.APP_ROUTE,page:"/api/agent/register/route",pathname:"/api/agent/register",filename:"route",bundlePath:"app/api/agent/register/route"},resolvedPagePath:"/workspaces/APP-Final/app/api/agent/register/route.ts",nextConfigOutput:"standalone",userland:a}),{requestAsyncStorage:R,staticGenerationAsyncStorage:E,serverHooks:v,headerHooks:_,staticGenerationBailout:S}=h,f="/api/agent/register/route";function T(){return(0,s.patchFetch)({serverHooks:v,staticGenerationAsyncStorage:E})}},8216:(e,t,r)=>{"use strict";var a;r.d(t,{k:()=>n}),function(e){e.DEBUG="DEBUG",e.INFO="INFO",e.WARN="WARN",e.ERROR="ERROR",e.CRITICAL="CRITICAL"}(a||(a={}));class i{formatLog(e){return JSON.stringify({...e,timestamp:new Date().toISOString()})}logApiRequest(e,t,r,a){let i=Date.now(),n=Math.random().toString(36).substr(2,9);return console.log(this.formatLog({timestamp:new Date().toISOString(),level:"INFO",service:e,action:t,userId:r,details:{...a,requestId:n,type:"REQUEST_START"}})),(a,s,o)=>{let l=Date.now()-i;console.log(this.formatLog({timestamp:new Date().toISOString(),level:a>=400?"ERROR":"INFO",service:e,action:t,userId:r,statusCode:a,duration:l,details:{...s,requestId:n,type:"REQUEST_END"},error:o?.message}))}}logTransaction(e,t,r,a,i){console.log(this.formatLog({timestamp:new Date().toISOString(),level:"SUCCESS"===a?"INFO":"WARN",service:"TRANSACTION",action:t,userId:e,details:{amount:r,status:a,...i}}))}logAuth(e,t,r,a){console.log(this.formatLog({timestamp:new Date().toISOString(),level:r?"INFO":"WARN",service:"AUTH",action:e,userId:t,details:{success:r,...a}}))}logSecurityEvent(e,t){console.log(this.formatLog({timestamp:new Date().toISOString(),level:"WARN",service:"SECURITY",action:e,details:t}))}logError(e,t,r,a){console.error(this.formatLog({timestamp:new Date().toISOString(),level:"ERROR",service:e,action:t,error:r.message,details:a}))}logCritical(e,t,r){console.error(this.formatLog({timestamp:new Date().toISOString(),level:"CRITICAL",service:"SYSTEM",action:e,error:t.message,details:r}))}logWebhook(e,t,r,a){console.log(this.formatLog({timestamp:new Date().toISOString(),level:"INFO",service:"WEBHOOK",action:e,details:{transactionId:t,status:r,...a}}))}logExternalApiCall(e,t,r,a,i,n){console.log(this.formatLog({timestamp:new Date().toISOString(),level:a>=400?"WARN":"DEBUG",service:`EXTERNAL_API_${e}`,action:`${r} ${t}`,statusCode:a,duration:i,details:n}))}logDatabaseOperation(e,t,r,a,i){console.log(this.formatLog({timestamp:new Date().toISOString(),level:a?"DEBUG":"ERROR",service:"DATABASE",action:`${e}_${t}`,duration:r,details:{success:a,...i}}))}}let n=new i},3214:(e,t,r)=>{"use strict";r.d(t,{_:()=>i});var a=r(3524);let i=globalThis.prisma||new a.PrismaClient({log:["query","error","warn"]})},951:(e,t,r)=>{"use strict";r.d(t,{Wq:()=>n,XK:()=>s});class a{isAllowed(e,t=5,r=9e5){let a=Date.now(),i=this.limits.get(e);return!i||a>i.resetTime?(this.limits.set(e,{count:1,resetTime:a+r}),!0):!(i.count>=t)&&(i.count++,!0)}getRemaining(e,t=5,r=9e5){let a=Date.now(),i=this.limits.get(e);return!i||a>i.resetTime?t:Math.max(0,t-i.count)}reset(e){this.limits.delete(e)}clear(){this.limits.clear()}getInfo(e,t=5,r=9e5){let a=Date.now(),i=this.limits.get(e);return!i||a>i.resetTime?{count:0,remaining:t,resetTime:a+r,isLimited:!1}:{count:i.count,remaining:Math.max(0,t-i.count),resetTime:i.resetTime,isLimited:i.count>=t}}constructor(){this.limits=new Map}}let i=new a,n={check:e=>i.isAllowed(`login:${e}`,5,9e5),getInfo:e=>i.getInfo(`login:${e}`,5,9e5),reset:e=>i.reset(`login:${e}`)},s={check:e=>i.isAllowed(`register:${e}`,3,36e5),getInfo:e=>i.getInfo(`register:${e}`,3,36e5),reset:e=>i.reset(`register:${e}`)}},2156:(e,t,r)=>{"use strict";r.d(t,{vj:()=>n,xM:()=>i});var a=r(5050);async function i(e){try{let t=await a.ZP.genSalt(10);return await a.ZP.hash(e,t)}catch(e){throw console.error("Error hashing PIN:",e),Error("Failed to hash PIN")}}async function n(e,t){try{return await a.ZP.compare(e,t)}catch(e){return console.error("Error verifying PIN:",e),!1}}},9856:(e,t,r)=>{"use strict";r.d(t,{A0:()=>n,Td:()=>l,ZB:()=>o,g1:()=>s,sQ:()=>u});var a=r(5252),i=r(2178);let n=a.Ry({firstName:a.Z_().min(2,"First name must be at least 2 characters").max(50),lastName:a.Z_().min(2,"Last name must be at least 2 characters").max(50),phone:a.Z_().regex(/^[0-9]{10,11}$/,"Invalid phone number"),pin:a.Z_().regex(/^[0-9]{4}$/,"PIN must be exactly 4 digits")}),s=a.Ry({phone:a.Z_().regex(/^[0-9]{10,11}$/,"Invalid phone number"),pin:a.Z_().regex(/^[0-9]{4}$/,"PIN must be exactly 4 digits")});a.Ry({tx_ref:a.Z_().min(1,"Transaction reference required")});let o=a.Ry({productId:a.Z_().uuid("Invalid product ID"),phone:a.Z_().regex(/^[0-9]{10,11}$/,"Invalid phone number"),name:a.Z_().min(2,"Name required").max(100),state:a.Z_().min(2,"State required").max(100),simId:a.Z_().uuid("Invalid SIM ID").optional()});a.Ry({phone:a.Z_().regex(/^[0-9]{10,11}$/,"Invalid phone number"),network:a.Km(["MTN","AIRTEL","GLO"]),planId:a.Rx().positive("Invalid plan ID"),agentId:a.Z_().uuid("Invalid agent ID").optional(),agentPin:a.Z_().regex(/^[0-9]{4}$/,"PIN must be exactly 4 digits").optional()}),a.Ry({amount:a.Rx().positive("Amount must be positive"),phone:a.Z_().regex(/^[0-9]{10,11}$/,"Invalid phone number"),agentId:a.Z_().uuid("Invalid agent ID"),agentPin:a.Z_().regex(/^[0-9]{4}$/,"PIN must be exactly 4 digits")});let l=a.Ry({agentId:a.Z_().uuid("Invalid agent ID"),agentPin:a.Z_().regex(/^[0-9]{4}$/,"PIN must be exactly 4 digits"),type:a.Km(["data","ecommerce"]),payload:a.Ry({planId:a.Z_().optional(),productId:a.Z_().optional(),simId:a.Z_().optional(),phone:a.Z_().optional(),name:a.Z_().optional(),state:a.Z_().optional()})});a.Ry({phone:a.Z_().regex(/^[0-9]{10,11}$/,"Invalid phone number"),message:a.Z_().min(10,"Message must be at least 10 characters").max(1e3),subject:a.Z_().optional()}),a.Ry({adminPassword:a.Z_().min(6,"Invalid password")}),a.Ry({agentId:a.Z_().uuid("Invalid agent ID"),amount:a.Rx().positive("Amount must be positive"),reason:a.Z_().optional(),adminPassword:a.Z_().min(6,"Invalid password")});let u=async(e,t)=>{try{let r=await t.parseAsync(e);return{valid:!0,data:r}}catch(e){if(e instanceof i.jm)return{valid:!1,errors:e};throw e}}},8272:(e,t,r)=>{"use strict";r.d(t,{Z:()=>u});var a=r(6113),i=r.n(a);let n={randomUUID:i().randomUUID},s=new Uint8Array(256),o=s.length,l=[];for(let e=0;e<256;++e)l.push((e+256).toString(16).slice(1));let u=function(e,t,r){if(n.randomUUID&&!t&&!e)return n.randomUUID();let a=(e=e||{}).random||(e.rng||function(){return o>s.length-16&&(i().randomFillSync(s),o=0),s.slice(o,o+=16)})();if(a[6]=15&a[6]|64,a[8]=63&a[8]|128,t){r=r||0;for(let e=0;e<16;++e)t[r+e]=a[e];return t}return function(e,t=0){return l[e[t+0]]+l[e[t+1]]+l[e[t+2]]+l[e[t+3]]+"-"+l[e[t+4]]+l[e[t+5]]+"-"+l[e[t+6]]+l[e[t+7]]+"-"+l[e[t+8]]+l[e[t+9]]+"-"+l[e[t+10]]+l[e[t+11]]+l[e[t+12]]+l[e[t+13]]+l[e[t+14]]+l[e[t+15]]}(a)}}};var t=require("../../../../webpack-runtime.js");t.C(e);var r=e=>t(t.s=e),a=t.X(0,[1638,6206,7901,8428,5252,7529],()=>r(5697));module.exports=a})();