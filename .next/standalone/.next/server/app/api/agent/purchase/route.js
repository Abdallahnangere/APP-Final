(()=>{var e={};e.id=78,e.ids=[78],e.modules={3524:e=>{"use strict";e.exports=require("@prisma/client")},517:e=>{"use strict";e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},9491:e=>{"use strict";e.exports=require("assert")},6113:e=>{"use strict";e.exports=require("crypto")},2361:e=>{"use strict";e.exports=require("events")},7147:e=>{"use strict";e.exports=require("fs")},3685:e=>{"use strict";e.exports=require("http")},5158:e=>{"use strict";e.exports=require("http2")},5687:e=>{"use strict";e.exports=require("https")},1808:e=>{"use strict";e.exports=require("net")},1017:e=>{"use strict";e.exports=require("path")},2781:e=>{"use strict";e.exports=require("stream")},4404:e=>{"use strict";e.exports=require("tls")},6224:e=>{"use strict";e.exports=require("tty")},7310:e=>{"use strict";e.exports=require("url")},3837:e=>{"use strict";e.exports=require("util")},9796:e=>{"use strict";e.exports=require("zlib")},7529:()=>{},8218:(e,t,r)=>{"use strict";r.r(t),r.d(t,{headerHooks:()=>g,originalPathname:()=>A,patchFetch:()=>y,requestAsyncStorage:()=>m,routeModule:()=>p,serverHooks:()=>f,staticGenerationAsyncStorage:()=>h,staticGenerationBailout:()=>w});var a={};r.r(a),r.d(a,{POST:()=>l});var s=r(5419),i=r(9108),n=r(9678),o=r(8070),u=r(3214),c=r(8272),d=r(2760);async function l(e){try{let{agentId:t,pin:r,type:a,payload:s}=await e.json(),i=await u._.agent.findUnique({where:{id:t}});if(!i||i.pin!==r)return o.Z.json({error:"Invalid PIN Authorization"},{status:401});if(!i.isActive)return o.Z.json({error:"Agent Account Suspended"},{status:403});let n=0,l="",p={};if("data"===a){let e=await u._.dataPlan.findUnique({where:{id:s.planId}});if(!e)return o.Z.json({error:"Invalid Plan"},{status:400});n=e.price,l=`Data: ${e.network} ${e.data}`,p={planId:e.id}}else if("ecommerce"===a){let e=await u._.product.findUnique({where:{id:s.productId}});if(!e)return o.Z.json({error:"Invalid Product"},{status:400});if(n=e.price,l=e.name,p={productId:e.id},s.simId){let e=await u._.product.findUnique({where:{id:s.simId}});e&&(n+=e.price,l+=` + ${e.name}`)}}if(i.balance<n)return o.Z.json({error:"Insufficient Wallet Balance"},{status:402});let m=`AGENT-${a.toUpperCase()}-${Date.now()}`,h=await u._.$transaction(async e=>(await e.agent.update({where:{id:i.id},data:{balance:{decrement:n}}}),await e.transaction.create({data:{tx_ref:m,type:a,status:"paid",phone:s.phone,amount:n,agentId:i.id,customerName:s.name||i.firstName,deliveryState:s.state||"Agent Direct",idempotencyKey:(0,c.Z)(),...p,deliveryData:{method:"Agent Wallet",manifest:l}}})));if("data"===a){let e=await u._.dataPlan.findUnique({where:{id:s.planId}});if(e){let t={network:d.Vi[e.network],mobile_number:s.phone,plan:Number(e.planId),Ported_number:!0},r=await (0,d.Ft)("/data/",t,m),a=r.success&&(!0===r.data.success||"successful"===r.data.Status||"delivered"===r.data.status||"successful"===r.data.status);await u._.transaction.update({where:{id:h.id},data:{status:a?"delivered":"failed",deliveryData:{...h.deliveryData,amigo_response:r.data,status:a?"delivered":"failed"}}})}}let f=await u._.transaction.findUnique({where:{id:h.id},include:{product:!0,dataPlan:!0}});return o.Z.json({success:!0,transaction:f})}catch(e){return console.error("Agent Purchase Error:",e),o.Z.json({error:e.message||"Transaction failed"},{status:500})}}let p=new s.AppRouteRouteModule({definition:{kind:i.x.APP_ROUTE,page:"/api/agent/purchase/route",pathname:"/api/agent/purchase",filename:"route",bundlePath:"app/api/agent/purchase/route"},resolvedPagePath:"/workspaces/APP-Final/app/api/agent/purchase/route.ts",nextConfigOutput:"standalone",userland:a}),{requestAsyncStorage:m,staticGenerationAsyncStorage:h,serverHooks:f,headerHooks:g,staticGenerationBailout:w}=p,A="/api/agent/purchase/route";function y(){return(0,n.patchFetch)({serverHooks:f,staticGenerationAsyncStorage:h})}},2760:(e,t,r)=>{"use strict";let a;r.d(t,{Ft:()=>d,Vi:()=>l});var s=r(8428),i=r(6489);let n=process.env.AMIGO_BASE_URL||"https://amigo.ng/api/data/",o=process.env.AWS_PROXY_URL,u=process.env.AMIGO_API_KEY||"";if(o)try{a=new i.j(o)}catch(e){console.error("Failed to initialize Proxy Agent",e)}let c=s.Z.create({httpsAgent:a,proxy:!1,headers:{"Content-Type":"application/json",Authorization:`Bearer ${u}`,Token:u,"X-API-Key":u,Accept:"application/json"},timeout:6e4});async function d(e,t,r){console.log(`[Amigo Tunnel] ðŸš€ Requesting: ${n}`),console.log(`[Amigo Tunnel] ðŸ“¦ Payload:`,JSON.stringify(t));try{let e={};r&&(e["Idempotency-Key"]=r);let a=await c.post(n,t,{headers:e});return console.log(`[Amigo Tunnel] âœ… Success: ${a.status}`),{success:!0,data:a.data,status:a.status}}catch(t){let e=t.response?.data?.message||t.message;return console.error(`[Amigo Tunnel] âŒ Failed: ${e}`),{success:!1,data:t.response?.data||{error:e},status:t.response?.status||500}}}let l={MTN:1,GLO:2,AIRTEL:4,"9MOBILE":9}},3214:(e,t,r)=>{"use strict";r.d(t,{_:()=>s});var a=r(3524);let s=globalThis.prisma||new a.PrismaClient({log:["query","error","warn"]})},8272:(e,t,r)=>{"use strict";r.d(t,{Z:()=>c});var a=r(6113),s=r.n(a);let i={randomUUID:s().randomUUID},n=new Uint8Array(256),o=n.length,u=[];for(let e=0;e<256;++e)u.push((e+256).toString(16).slice(1));let c=function(e,t,r){if(i.randomUUID&&!t&&!e)return i.randomUUID();let a=(e=e||{}).random||(e.rng||function(){return o>n.length-16&&(s().randomFillSync(n),o=0),n.slice(o,o+=16)})();if(a[6]=15&a[6]|64,a[8]=63&a[8]|128,t){r=r||0;for(let e=0;e<16;++e)t[r+e]=a[e];return t}return function(e,t=0){return u[e[t+0]]+u[e[t+1]]+u[e[t+2]]+u[e[t+3]]+"-"+u[e[t+4]]+u[e[t+5]]+"-"+u[e[t+6]]+u[e[t+7]]+"-"+u[e[t+8]]+u[e[t+9]]+"-"+u[e[t+10]]+u[e[t+11]]+u[e[t+12]]+u[e[t+13]]+u[e[t+14]]+u[e[t+15]]}(a)}}};var t=require("../../../../webpack-runtime.js");t.C(e);var r=e=>t(t.s=e),a=t.X(0,[638,206,428,489],()=>r(8218));module.exports=a})();