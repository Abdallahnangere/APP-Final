"use strict";(()=>{var e={};e.id=5078,e.ids=[5078],e.modules={3524:e=>{e.exports=require("@prisma/client")},517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},9491:e=>{e.exports=require("assert")},6113:e=>{e.exports=require("crypto")},2361:e=>{e.exports=require("events")},7147:e=>{e.exports=require("fs")},3685:e=>{e.exports=require("http")},5158:e=>{e.exports=require("http2")},5687:e=>{e.exports=require("https")},1808:e=>{e.exports=require("net")},2037:e=>{e.exports=require("os")},1017:e=>{e.exports=require("path")},2781:e=>{e.exports=require("stream")},4404:e=>{e.exports=require("tls")},6224:e=>{e.exports=require("tty")},7310:e=>{e.exports=require("url")},3837:e=>{e.exports=require("util")},9796:e=>{e.exports=require("zlib")},8218:(e,t,a)=>{a.r(t),a.d(t,{headerHooks:()=>y,originalPathname:()=>w,patchFetch:()=>A,requestAsyncStorage:()=>I,routeModule:()=>g,serverHooks:()=>f,staticGenerationAsyncStorage:()=>h,staticGenerationBailout:()=>v});var r={};a.r(r),a.d(r,{POST:()=>m});var n=a(5419),i=a(9108),o=a(9678),s=a(8070),l=a(3214),d=a(8272),u=a(313),c=a(2156),p=a(9856);async function m(e){try{let t=await e.json(),a=await (0,p.sQ)(t,p.Td);if(!a.valid){let e=a.errors.errors.map(e=>`${e.path.join(".")}: ${e.message}`);return s.Z.json({error:"Validation failed",details:e},{status:400})}let{agentId:r,agentPin:n,type:i,payload:o}=a.data,m=await l._.agent.findUnique({where:{id:r}});if(!m)return s.Z.json({error:"Agent not found"},{status:404});if(!await (0,c.vj)(n,m.pin))return console.error(`[PIN VERIFICATION FAILED] Agent: ${r}, Input PIN length: ${n.length}, Stored hash length: ${m.pin.length}`),s.Z.json({error:"Invalid PIN. Please check and try again."},{status:401});if(!m.isActive)return s.Z.json({error:"Agent Account Suspended"},{status:403});let g=0,I="",h={};if("data"===i&&o?.planId){let e=await l._.dataPlan.findUnique({where:{id:o.planId}});if(!e)return s.Z.json({error:"Invalid Plan"},{status:400});g=e.price,I=`Data: ${e.network} ${e.data}`,h={planId:e.id}}else if("ecommerce"===i&&o?.productId){let e=await l._.product.findUnique({where:{id:o.productId}});if(!e)return s.Z.json({error:"Invalid Product"},{status:400});if(g=e.price,I=e.name,h={productId:e.id},o.simId){let e=await l._.product.findUnique({where:{id:o.simId}});e&&(g+=e.price,I+=` + ${e.name}`)}}if(m.balance<g)return s.Z.json({error:"Insufficient Wallet Balance"},{status:402});let f=.02*g,y=`AGENT-${i?.toUpperCase()||"TX"}-${Date.now()}`,v=!0,w=null;if("data"===i){let e=await l._.dataPlan.findUnique({where:{id:o.planId}});if(e)try{let t={network:u.Vi[e.network],mobile_number:o.phone,plan:Number(e.planId),Ported_number:!0},a=await (0,u.Ft)("/data/",t,y);if(v=a.success&&(!0===a.data.success||"successful"===a.data.Status||"delivered"===a.data.status||"successful"===a.data.status),w=a.data,!v)return s.Z.json({error:"Network provider failed to process request. Wallet NOT deducted.",details:w},{status:400})}catch(e){return s.Z.json({error:"Network provider API error. Wallet NOT deducted. Please try again.",details:e.message},{status:500})}}let A=await l._.$transaction(async e=>{await e.agent.update({where:{id:m.id},data:{balance:{decrement:g},cashbackBalance:{increment:f},totalCashbackEarned:{increment:f}}});let t=await e.transaction.create({data:{tx_ref:y,type:i,status:"data"===i?"delivered":"paid",phone:o.phone,amount:g,agentCashbackAmount:f,cashbackProcessed:!0,agentId:m.id,customerName:o.name||m.firstName,deliveryState:o.state||"Agent Direct",idempotencyKey:(0,d.Z)(),...h,deliveryData:{method:"Agent Wallet",manifest:I,cashbackEarned:f,...w&&{amigo_response:w}}}});return await e.cashbackEntry.create({data:{agentId:m.id,type:"earned",amount:f,transactionId:t.id,description:`2% cashback on ${I}`}}),t}),x=await l._.transaction.findUnique({where:{id:A.id},include:{product:!0,dataPlan:!0}});return s.Z.json({success:!0,transaction:x})}catch(e){return console.error("Agent Purchase Error:",e),s.Z.json({error:e.message||"Transaction failed"},{status:500})}}let g=new n.AppRouteRouteModule({definition:{kind:i.x.APP_ROUTE,page:"/api/agent/purchase/route",pathname:"/api/agent/purchase",filename:"route",bundlePath:"app/api/agent/purchase/route"},resolvedPagePath:"/workspaces/APP-Final/app/api/agent/purchase/route.ts",nextConfigOutput:"standalone",userland:r}),{requestAsyncStorage:I,staticGenerationAsyncStorage:h,serverHooks:f,headerHooks:y,staticGenerationBailout:v}=g,w="/api/agent/purchase/route";function A(){return(0,o.patchFetch)({serverHooks:f,staticGenerationAsyncStorage:h})}},313:(e,t,a)=>{let r;a.d(t,{Vi:()=>g,Ft:()=>m});var n=a(8428),i=a(6489);let o={maxRetries:3,initialDelayMs:1e3,maxDelayMs:3e4,backoffMultiplier:2,shouldRetry:e=>!!(!e||"ECONNREFUSED"===e.code||"ETIMEDOUT"===e.code||e.response?.status>=500)};async function s(e,t={}){let a;let r={...o,...t},n=r.initialDelayMs;for(let t=0;t<=r.maxRetries;t++)try{return await e()}catch(e){if(a=e,t===r.maxRetries)break;if(!r.shouldRetry(e))throw e;await function(e){return new Promise(t=>setTimeout(t,e))}(n),n=Math.min(n*r.backoffMultiplier,r.maxDelayMs)}throw a}var l=a(8216);let d=process.env.AMIGO_BASE_URL||"https://amigo.ng/api/data/",u=process.env.AWS_PROXY_URL,c=process.env.AMIGO_API_KEY||"";if(u)try{r=new i.HttpsProxyAgent(u)}catch(e){console.error("Failed to initialize Proxy Agent",e)}let p=n.Z.create({httpsAgent:r,proxy:!1,headers:{"Content-Type":"application/json",Authorization:`Bearer ${c}`,Token:c,"X-API-Key":c,Accept:"application/json"},timeout:6e4});async function m(e,t,a){l.k.logExternalApiCall("AMIGO",d,"POST",0,0,{hasIdempotencyKey:!!a});try{let e=await s(async()=>{let e={};a&&(e["Idempotency-Key"]=a);let r=Date.now(),n=await p.post(d,t,{headers:e}),i=Date.now()-r;return l.k.logExternalApiCall("AMIGO",d,"POST",n.status,i),{success:!0,data:n.data,status:n.status}},{maxRetries:3,initialDelayMs:1e3,maxDelayMs:1e4,shouldRetry:e=>!!("ECONNREFUSED"===e.code||"ETIMEDOUT"===e.code||e.response?.status>=500)});return console.log(`[Amigo API] ✅ Success: ${e.status}`),e}catch(a){let e=a.response?.data?.message||a.message,t=a.response?.status||500;return l.k.logExternalApiCall("AMIGO",d,"POST",t,0,{error:e,retried:!0}),console.error(`[Amigo API] ❌ Failed: ${e}`),{success:!1,data:a.response?.data||{error:e},status:t}}}let g={MTN:1,GLO:2,AIRTEL:4,"9MOBILE":9}},8216:(e,t,a)=>{var r;a.d(t,{k:()=>i}),function(e){e.DEBUG="DEBUG",e.INFO="INFO",e.WARN="WARN",e.ERROR="ERROR",e.CRITICAL="CRITICAL"}(r||(r={}));class n{formatLog(e){return JSON.stringify({...e,timestamp:new Date().toISOString()})}logApiRequest(e,t,a,r){let n=Date.now(),i=Math.random().toString(36).substr(2,9);return console.log(this.formatLog({timestamp:new Date().toISOString(),level:"INFO",service:e,action:t,userId:a,details:{...r,requestId:i,type:"REQUEST_START"}})),(r,o,s)=>{let l=Date.now()-n;console.log(this.formatLog({timestamp:new Date().toISOString(),level:r>=400?"ERROR":"INFO",service:e,action:t,userId:a,statusCode:r,duration:l,details:{...o,requestId:i,type:"REQUEST_END"},error:s?.message}))}}logTransaction(e,t,a,r,n){console.log(this.formatLog({timestamp:new Date().toISOString(),level:"SUCCESS"===r?"INFO":"WARN",service:"TRANSACTION",action:t,userId:e,details:{amount:a,status:r,...n}}))}logAuth(e,t,a,r){console.log(this.formatLog({timestamp:new Date().toISOString(),level:a?"INFO":"WARN",service:"AUTH",action:e,userId:t,details:{success:a,...r}}))}logSecurityEvent(e,t){console.log(this.formatLog({timestamp:new Date().toISOString(),level:"WARN",service:"SECURITY",action:e,details:t}))}logError(e,t,a,r){console.error(this.formatLog({timestamp:new Date().toISOString(),level:"ERROR",service:e,action:t,error:a.message,details:r}))}logCritical(e,t,a){console.error(this.formatLog({timestamp:new Date().toISOString(),level:"CRITICAL",service:"SYSTEM",action:e,error:t.message,details:a}))}logWebhook(e,t,a,r){console.log(this.formatLog({timestamp:new Date().toISOString(),level:"INFO",service:"WEBHOOK",action:e,details:{transactionId:t,status:a,...r}}))}logExternalApiCall(e,t,a,r,n,i){console.log(this.formatLog({timestamp:new Date().toISOString(),level:r>=400?"WARN":"DEBUG",service:`EXTERNAL_API_${e}`,action:`${a} ${t}`,statusCode:r,duration:n,details:i}))}logDatabaseOperation(e,t,a,r,n){console.log(this.formatLog({timestamp:new Date().toISOString(),level:r?"DEBUG":"ERROR",service:"DATABASE",action:`${e}_${t}`,duration:a,details:{success:r,...n}}))}}let i=new n},3214:(e,t,a)=>{a.d(t,{_:()=>n});var r=a(3524);let n=globalThis.prisma||new r.PrismaClient({log:["query","error","warn"]})},2156:(e,t,a)=>{a.d(t,{vj:()=>i,xM:()=>n});var r=a(7529);async function n(e){try{let t=await r.ZP.genSalt(10);return await r.ZP.hash(e,t)}catch(e){throw console.error("Error hashing PIN:",e),Error("Failed to hash PIN")}}async function i(e,t){try{return await r.ZP.compare(e,t)}catch(e){return console.error("Error verifying PIN:",e),!1}}},9856:(e,t,a)=>{a.d(t,{A0:()=>i,Td:()=>l,ZB:()=>s,g1:()=>o,sQ:()=>d});var r=a(5252),n=a(2178);let i=r.Ry({firstName:r.Z_().min(2,"First name must be at least 2 characters").max(50),lastName:r.Z_().min(2,"Last name must be at least 2 characters").max(50),phone:r.Z_().regex(/^[0-9]{10,11}$/,"Invalid phone number"),pin:r.Z_().regex(/^[0-9]{4}$/,"PIN must be exactly 4 digits")}),o=r.Ry({phone:r.Z_().regex(/^[0-9]{10,11}$/,"Invalid phone number"),pin:r.Z_().regex(/^[0-9]{4}$/,"PIN must be exactly 4 digits")});r.Ry({tx_ref:r.Z_().min(1,"Transaction reference required")});let s=r.Ry({productId:r.Z_().min(1,"Product ID required"),phone:r.Z_().regex(/^[0-9]{10,11}$/,"Invalid phone number"),name:r.Z_().min(2,"Name required").max(100),state:r.Z_().min(2,"State required").max(100),simId:r.Z_().optional()});r.Ry({phone:r.Z_().regex(/^[0-9]{10,11}$/,"Invalid phone number"),network:r.Km(["MTN","AIRTEL","GLO"]),planId:r.Rx().positive("Invalid plan ID"),agentId:r.Z_().uuid("Invalid agent ID").optional(),agentPin:r.Z_().regex(/^[0-9]{4}$/,"PIN must be exactly 4 digits").optional()}),r.Ry({amount:r.Rx().positive("Amount must be positive"),phone:r.Z_().regex(/^[0-9]{10,11}$/,"Invalid phone number"),agentId:r.Z_().uuid("Invalid agent ID"),agentPin:r.Z_().regex(/^[0-9]{4}$/,"PIN must be exactly 4 digits")});let l=r.Ry({agentId:r.Z_().uuid("Invalid agent ID"),agentPin:r.Z_().regex(/^[0-9]{4}$/,"PIN must be exactly 4 digits"),type:r.Km(["data","ecommerce"]),payload:r.Ry({planId:r.Z_().optional(),productId:r.Z_().optional(),simId:r.Z_().optional(),phone:r.Z_().regex(/^[0-9]{10,11}$/,"Invalid phone number").optional(),name:r.Z_().min(2).max(100).optional(),state:r.Z_().min(2).max(100).optional()}).strict()});r.Ry({phone:r.Z_().regex(/^[0-9]{10,11}$/,"Invalid phone number"),message:r.Z_().min(10,"Message must be at least 10 characters").max(1e3),subject:r.Z_().optional()}),r.Ry({adminPassword:r.Z_().min(6,"Invalid password")}),r.Ry({agentId:r.Z_().uuid("Invalid agent ID"),amount:r.Rx().positive("Amount must be positive"),reason:r.Z_().optional(),adminPassword:r.Z_().min(6,"Invalid password")});let d=async(e,t)=>{try{let a=await t.parseAsync(e);return{valid:!0,data:a}}catch(e){if(e instanceof n.jm)return{valid:!1,errors:e};throw e}}},8272:(e,t,a)=>{a.d(t,{Z:()=>d});var r=a(6113),n=a.n(r);let i={randomUUID:n().randomUUID},o=new Uint8Array(256),s=o.length,l=[];for(let e=0;e<256;++e)l.push((e+256).toString(16).slice(1));let d=function(e,t,a){if(i.randomUUID&&!t&&!e)return i.randomUUID();let r=(e=e||{}).random||(e.rng||function(){return s>o.length-16&&(n().randomFillSync(o),s=0),o.slice(s,s+=16)})();if(r[6]=15&r[6]|64,r[8]=63&r[8]|128,t){a=a||0;for(let e=0;e<16;++e)t[a+e]=r[e];return t}return function(e,t=0){return l[e[t+0]]+l[e[t+1]]+l[e[t+2]]+l[e[t+3]]+"-"+l[e[t+4]]+l[e[t+5]]+"-"+l[e[t+6]]+l[e[t+7]]+"-"+l[e[t+8]]+l[e[t+9]]+"-"+l[e[t+10]]+l[e[t+11]]+l[e[t+12]]+l[e[t+13]]+l[e[t+14]]+l[e[t+15]]}(r)}}};var t=require("../../../../webpack-runtime.js");t.C(e);var a=e=>t(t.s=e),r=t.X(0,[1638,6206,7901,8428,6489,5252,7529],()=>a(8218));module.exports=r})();