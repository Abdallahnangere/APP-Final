(()=>{var e={};e.id=287,e.ids=[287],e.modules={3524:e=>{"use strict";e.exports=require("@prisma/client")},517:e=>{"use strict";e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},9491:e=>{"use strict";e.exports=require("assert")},6113:e=>{"use strict";e.exports=require("crypto")},2361:e=>{"use strict";e.exports=require("events")},7147:e=>{"use strict";e.exports=require("fs")},3685:e=>{"use strict";e.exports=require("http")},5158:e=>{"use strict";e.exports=require("http2")},5687:e=>{"use strict";e.exports=require("https")},1808:e=>{"use strict";e.exports=require("net")},1017:e=>{"use strict";e.exports=require("path")},2781:e=>{"use strict";e.exports=require("stream")},4404:e=>{"use strict";e.exports=require("tls")},6224:e=>{"use strict";e.exports=require("tty")},7310:e=>{"use strict";e.exports=require("url")},3837:e=>{"use strict";e.exports=require("util")},9796:e=>{"use strict";e.exports=require("zlib")},7529:()=>{},5478:(e,t,r)=>{"use strict";r.r(t),r.d(t,{headerHooks:()=>v,originalPathname:()=>g,patchFetch:()=>A,requestAsyncStorage:()=>f,routeModule:()=>y,serverHooks:()=>h,staticGenerationAsyncStorage:()=>m,staticGenerationBailout:()=>w});var a={};r.r(a),r.d(a,{POST:()=>p});var s=r(5419),i=r(9108),o=r(9678),n=r(8070),u=r(3214),c=r(8428),d=r(2760),l=r(3524);async function p(e){try{let{tx_ref:t}=await e.json(),r=await u._.transaction.findUnique({where:{tx_ref:t},include:{dataPlan:!0,product:!0}});if(!r)return n.Z.json({error:"Transaction not found"},{status:404});if("delivered"===r.status)return n.Z.json({status:"delivered"});let a=r.status;if("pending"===a)try{let e=await c.Z.get(`https://api.flutterwave.com/v3/transactions/verify_by_reference?tx_ref=${t}`,{headers:{Authorization:`Bearer ${process.env.FLUTTERWAVE_SECRET_KEY}`}}),s=e.data.data;"success"===e.data.status&&("successful"===s.status||"completed"===s.status)&&s.amount>=r.amount&&(r=await u._.transaction.update({where:{id:r.id},data:{status:"paid",paymentData:s},include:{dataPlan:!0,product:!0}}),a="paid")}catch(e){console.error("FLW Verify Error",e)}if("paid"===a&&"data"===r.type){if((await u._.transaction.updateMany({where:{id:r.id,OR:[{deliveryData:{equals:l.Prisma.DbNull}},{deliveryData:{equals:l.Prisma.JsonNull}}]},data:{deliveryData:{status:"processing",timestamp:Date.now()}}})).count>0){let e=r.dataPlan;if(e){let s={network:d.Vi[e.network],mobile_number:r.phone,plan:Number(e.planId),Ported_number:!0};try{let e=await (0,d.Ft)("/data/",s,t);e.success&&(!0===e.data.success||"successful"===e.data.Status||"delivered"===e.data.status||"successful"===e.data.status)?(await u._.transaction.update({where:{id:r.id},data:{status:"delivered",deliveryData:e.data}}),a="delivered"):await u._.transaction.update({where:{id:r.id},data:{deliveryData:{...e.data,error:"Amigo API Failed",failedAt:Date.now()}}})}catch(e){await u._.transaction.update({where:{id:r.id},data:{deliveryData:{error:e.message,failedAt:Date.now()}}})}}}else{let e=await u._.transaction.findUnique({where:{id:r.id}});a=e?.status||a}}return n.Z.json({status:a})}catch(e){return console.error("Verification Error:",e),n.Z.json({error:"Verification failed"},{status:500})}}let y=new s.AppRouteRouteModule({definition:{kind:i.x.APP_ROUTE,page:"/api/transactions/verify/route",pathname:"/api/transactions/verify",filename:"route",bundlePath:"app/api/transactions/verify/route"},resolvedPagePath:"/workspaces/APP-Final/app/api/transactions/verify/route.ts",nextConfigOutput:"standalone",userland:a}),{requestAsyncStorage:f,staticGenerationAsyncStorage:m,serverHooks:h,headerHooks:v,staticGenerationBailout:w}=y,g="/api/transactions/verify/route";function A(){return(0,o.patchFetch)({serverHooks:h,staticGenerationAsyncStorage:m})}},2760:(e,t,r)=>{"use strict";let a;r.d(t,{Ft:()=>d,Vi:()=>l});var s=r(8428),i=r(6489);let o=process.env.AMIGO_BASE_URL||"https://amigo.ng/api/data/",n=process.env.AWS_PROXY_URL,u=process.env.AMIGO_API_KEY||"";if(n)try{a=new i.j(n)}catch(e){console.error("Failed to initialize Proxy Agent",e)}let c=s.Z.create({httpsAgent:a,proxy:!1,headers:{"Content-Type":"application/json",Authorization:`Bearer ${u}`,Token:u,"X-API-Key":u,Accept:"application/json"},timeout:6e4});async function d(e,t,r){console.log(`[Amigo Tunnel] ðŸš€ Requesting: ${o}`),console.log(`[Amigo Tunnel] ðŸ“¦ Payload:`,JSON.stringify(t));try{let e={};r&&(e["Idempotency-Key"]=r);let a=await c.post(o,t,{headers:e});return console.log(`[Amigo Tunnel] âœ… Success: ${a.status}`),{success:!0,data:a.data,status:a.status}}catch(t){let e=t.response?.data?.message||t.message;return console.error(`[Amigo Tunnel] âŒ Failed: ${e}`),{success:!1,data:t.response?.data||{error:e},status:t.response?.status||500}}}let l={MTN:1,GLO:2,AIRTEL:4,"9MOBILE":9}},3214:(e,t,r)=>{"use strict";r.d(t,{_:()=>s});var a=r(3524);let s=globalThis.prisma||new a.PrismaClient({log:["query","error","warn"]})}};var t=require("../../../../webpack-runtime.js");t.C(e);var r=e=>t(t.s=e),a=t.X(0,[638,206,428,489],()=>r(5478));module.exports=a})();