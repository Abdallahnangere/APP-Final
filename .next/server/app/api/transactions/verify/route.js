(()=>{var e={};e.id=287,e.ids=[287],e.modules={3524:e=>{"use strict";e.exports=require("@prisma/client")},517:e=>{"use strict";e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},9491:e=>{"use strict";e.exports=require("assert")},6113:e=>{"use strict";e.exports=require("crypto")},2361:e=>{"use strict";e.exports=require("events")},7147:e=>{"use strict";e.exports=require("fs")},3685:e=>{"use strict";e.exports=require("http")},5158:e=>{"use strict";e.exports=require("http2")},5687:e=>{"use strict";e.exports=require("https")},1808:e=>{"use strict";e.exports=require("net")},1017:e=>{"use strict";e.exports=require("path")},2781:e=>{"use strict";e.exports=require("stream")},4404:e=>{"use strict";e.exports=require("tls")},6224:e=>{"use strict";e.exports=require("tty")},7310:e=>{"use strict";e.exports=require("url")},3837:e=>{"use strict";e.exports=require("util")},9796:e=>{"use strict";e.exports=require("zlib")},7529:()=>{},5478:(e,t,a)=>{"use strict";a.r(t),a.d(t,{headerHooks:()=>v,originalPathname:()=>A,patchFetch:()=>w,requestAsyncStorage:()=>g,routeModule:()=>m,serverHooks:()=>h,staticGenerationAsyncStorage:()=>f,staticGenerationBailout:()=>y});var r={};a.r(r),a.d(r,{POST:()=>p});var s=a(5419),i=a(9108),o=a(9678),n=a(8070),l=a(3214),u=a(8428),c=a(313),d=a(3524);async function p(e){try{let{tx_ref:t}=await e.json(),a=await l._.transaction.findUnique({where:{tx_ref:t},include:{dataPlan:!0,product:!0}});if(!a)return n.Z.json({error:"Transaction not found"},{status:404});if("delivered"===a.status)return n.Z.json({status:"delivered"});let r=a.status;if("pending"===r)try{let e=await u.Z.get(`https://api.flutterwave.com/v3/transactions/verify_by_reference?tx_ref=${t}`,{headers:{Authorization:`Bearer ${process.env.FLUTTERWAVE_SECRET_KEY}`}}),s=e.data.data;"success"===e.data.status&&("successful"===s.status||"completed"===s.status)&&s.amount>=a.amount&&(a=await l._.transaction.update({where:{id:a.id},data:{status:"paid",paymentData:s},include:{dataPlan:!0,product:!0}}),r="paid")}catch(e){console.error("FLW Verify Error",e)}if("paid"===r&&"data"===a.type){if((await l._.transaction.updateMany({where:{id:a.id,OR:[{deliveryData:{equals:d.Prisma.DbNull}},{deliveryData:{equals:d.Prisma.JsonNull}}]},data:{deliveryData:{status:"processing",timestamp:Date.now()}}})).count>0){let e=a.dataPlan;if(e){let s={network:c.Vi[e.network],mobile_number:a.phone,plan:Number(e.planId),Ported_number:!0};try{let e=await (0,c.Ft)("/data/",s,t);e.success&&(!0===e.data.success||"successful"===e.data.Status||"delivered"===e.data.status||"successful"===e.data.status)?(await l._.transaction.update({where:{id:a.id},data:{status:"delivered",deliveryData:e.data}}),r="delivered"):await l._.transaction.update({where:{id:a.id},data:{deliveryData:{...e.data,error:"Amigo API Failed",failedAt:Date.now()}}})}catch(e){await l._.transaction.update({where:{id:a.id},data:{deliveryData:{error:e.message,failedAt:Date.now()}}})}}}else{let e=await l._.transaction.findUnique({where:{id:a.id}});r=e?.status||r}}return n.Z.json({status:r})}catch(e){return console.error("Verification Error:",e),n.Z.json({error:"Verification failed"},{status:500})}}let m=new s.AppRouteRouteModule({definition:{kind:i.x.APP_ROUTE,page:"/api/transactions/verify/route",pathname:"/api/transactions/verify",filename:"route",bundlePath:"app/api/transactions/verify/route"},resolvedPagePath:"/workspaces/APP-Final/app/api/transactions/verify/route.ts",nextConfigOutput:"standalone",userland:r}),{requestAsyncStorage:g,staticGenerationAsyncStorage:f,serverHooks:h,headerHooks:v,staticGenerationBailout:y}=m,A="/api/transactions/verify/route";function w(){return(0,o.patchFetch)({serverHooks:h,staticGenerationAsyncStorage:f})}},313:(e,t,a)=>{"use strict";let r;a.d(t,{Vi:()=>g,Ft:()=>m});var s=a(8428),i=a(6489);let o={maxRetries:3,initialDelayMs:1e3,maxDelayMs:3e4,backoffMultiplier:2,shouldRetry:e=>!!(!e||"ECONNREFUSED"===e.code||"ETIMEDOUT"===e.code||e.response?.status>=500)};async function n(e,t={}){let a;let r={...o,...t},s=r.initialDelayMs;for(let t=0;t<=r.maxRetries;t++)try{return await e()}catch(e){if(a=e,t===r.maxRetries)break;if(!r.shouldRetry(e))throw e;await function(e){return new Promise(t=>setTimeout(t,e))}(s),s=Math.min(s*r.backoffMultiplier,r.maxDelayMs)}throw a}var l=a(8216);let u=process.env.AMIGO_BASE_URL||"https://amigo.ng/api/data/",c=process.env.AWS_PROXY_URL,d=process.env.AMIGO_API_KEY||"";if(c)try{r=new i.HttpsProxyAgent(c)}catch(e){console.error("Failed to initialize Proxy Agent",e)}let p=s.Z.create({httpsAgent:r,proxy:!1,headers:{"Content-Type":"application/json",Authorization:`Bearer ${d}`,Token:d,"X-API-Key":d,Accept:"application/json"},timeout:6e4});async function m(e,t,a){l.k.logExternalApiCall("AMIGO",u,"POST",0,0,{hasIdempotencyKey:!!a});try{let e=await n(async()=>{let e={};a&&(e["Idempotency-Key"]=a);let r=Date.now(),s=await p.post(u,t,{headers:e}),i=Date.now()-r;return l.k.logExternalApiCall("AMIGO",u,"POST",s.status,i),{success:!0,data:s.data,status:s.status}},{maxRetries:3,initialDelayMs:1e3,maxDelayMs:1e4,shouldRetry:e=>!!("ECONNREFUSED"===e.code||"ETIMEDOUT"===e.code||e.response?.status>=500)});return console.log(`[Amigo API] ✅ Success: ${e.status}`),e}catch(a){let e=a.response?.data?.message||a.message,t=a.response?.status||500;return l.k.logExternalApiCall("AMIGO",u,"POST",t,0,{error:e,retried:!0}),console.error(`[Amigo API] ❌ Failed: ${e}`),{success:!1,data:a.response?.data||{error:e},status:t}}}let g={MTN:1,GLO:2,AIRTEL:4,"9MOBILE":9}},8216:(e,t,a)=>{"use strict";var r;a.d(t,{k:()=>i}),function(e){e.DEBUG="DEBUG",e.INFO="INFO",e.WARN="WARN",e.ERROR="ERROR",e.CRITICAL="CRITICAL"}(r||(r={}));class s{formatLog(e){return JSON.stringify({...e,timestamp:new Date().toISOString()})}logApiRequest(e,t,a,r){let s=Date.now(),i=Math.random().toString(36).substr(2,9);return console.log(this.formatLog({timestamp:new Date().toISOString(),level:"INFO",service:e,action:t,userId:a,details:{...r,requestId:i,type:"REQUEST_START"}})),(r,o,n)=>{let l=Date.now()-s;console.log(this.formatLog({timestamp:new Date().toISOString(),level:r>=400?"ERROR":"INFO",service:e,action:t,userId:a,statusCode:r,duration:l,details:{...o,requestId:i,type:"REQUEST_END"},error:n?.message}))}}logTransaction(e,t,a,r,s){console.log(this.formatLog({timestamp:new Date().toISOString(),level:"SUCCESS"===r?"INFO":"WARN",service:"TRANSACTION",action:t,userId:e,details:{amount:a,status:r,...s}}))}logAuth(e,t,a,r){console.log(this.formatLog({timestamp:new Date().toISOString(),level:a?"INFO":"WARN",service:"AUTH",action:e,userId:t,details:{success:a,...r}}))}logSecurityEvent(e,t){console.log(this.formatLog({timestamp:new Date().toISOString(),level:"WARN",service:"SECURITY",action:e,details:t}))}logError(e,t,a,r){console.error(this.formatLog({timestamp:new Date().toISOString(),level:"ERROR",service:e,action:t,error:a.message,details:r}))}logCritical(e,t,a){console.error(this.formatLog({timestamp:new Date().toISOString(),level:"CRITICAL",service:"SYSTEM",action:e,error:t.message,details:a}))}logWebhook(e,t,a,r){console.log(this.formatLog({timestamp:new Date().toISOString(),level:"INFO",service:"WEBHOOK",action:e,details:{transactionId:t,status:a,...r}}))}logExternalApiCall(e,t,a,r,s,i){console.log(this.formatLog({timestamp:new Date().toISOString(),level:r>=400?"WARN":"DEBUG",service:`EXTERNAL_API_${e}`,action:`${a} ${t}`,statusCode:r,duration:s,details:i}))}logDatabaseOperation(e,t,a,r,s){console.log(this.formatLog({timestamp:new Date().toISOString(),level:r?"DEBUG":"ERROR",service:"DATABASE",action:`${e}_${t}`,duration:a,details:{success:r,...s}}))}}let i=new s},3214:(e,t,a)=>{"use strict";a.d(t,{_:()=>s});var r=a(3524);let s=globalThis.prisma||new r.PrismaClient({log:["query","error","warn"]})}};var t=require("../../../../webpack-runtime.js");t.C(e);var a=e=>t(t.s=e),r=t.X(0,[1638,6206,7901,8428,6489],()=>a(5478));module.exports=r})();