(()=>{var e={};e.id=9100,e.ids=[9100],e.modules={3524:e=>{"use strict";e.exports=require("@prisma/client")},517:e=>{"use strict";e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},9491:e=>{"use strict";e.exports=require("assert")},6113:e=>{"use strict";e.exports=require("crypto")},2361:e=>{"use strict";e.exports=require("events")},7147:e=>{"use strict";e.exports=require("fs")},3685:e=>{"use strict";e.exports=require("http")},5158:e=>{"use strict";e.exports=require("http2")},5687:e=>{"use strict";e.exports=require("https")},1808:e=>{"use strict";e.exports=require("net")},1017:e=>{"use strict";e.exports=require("path")},2781:e=>{"use strict";e.exports=require("stream")},4404:e=>{"use strict";e.exports=require("tls")},6224:e=>{"use strict";e.exports=require("tty")},7310:e=>{"use strict";e.exports=require("url")},3837:e=>{"use strict";e.exports=require("util")},9796:e=>{"use strict";e.exports=require("zlib")},7529:()=>{},5245:(e,t,r)=>{"use strict";r.r(t),r.d(t,{headerHooks:()=>w,originalPathname:()=>v,patchFetch:()=>y,requestAsyncStorage:()=>m,routeModule:()=>p,serverHooks:()=>h,staticGenerationAsyncStorage:()=>g,staticGenerationBailout:()=>f});var a={};r.r(a),r.d(a,{POST:()=>d});var s=r(5419),o=r(9108),i=r(9678),n=r(8070),l=r(3214),u=r(313),c=r(3524);async function d(e){let t=process.env.FLUTTERWAVE_WEBHOOK_SECRET,r=e.headers.get("verif-hash");if(t&&r!==t)return n.Z.json({error:"Invalid signature"},{status:401});try{let t=await e.json(),r=t.data||t;try{await l._.webhookLog.create({data:{source:"flutterwave",payload:t}})}catch(e){console.error("Logging failed",e)}let a=(r.status||"").toLowerCase(),s=Number(r.amount),o=r.customer?.phone_number||r.phone_number,i=String(r.id),d=r.txRef||r.tx_ref||r.reference;if(console.log(`[Webhook] ID: ${i} | Ref: ${d} | Phone: ${o} | Status: ${a}`),!("successful"===a||"completed"===a||"success"===a||"bank_transfer"===r.charge_type&&s>0))return n.Z.json({received:!0});if(o){let e=await l._.agent.findUnique({where:{phone:o}});if(e){let t=`FUND-${i}`;if(await l._.transaction.findUnique({where:{tx_ref:t}}))return n.Z.json({received:!0});return await l._.$transaction([l._.agent.update({where:{id:e.id},data:{balance:{increment:s}}}),l._.transaction.create({data:{tx_ref:t,type:"wallet_funding",status:"delivered",phone:e.phone,amount:s,agentId:e.id,paymentData:r,deliveryData:{method:"Virtual Account Deposit",original_flw_ref:d,flw_id:i}}})]),n.Z.json({received:!0})}}if(d&&!d.startsWith("FUND-")){let e=await l._.transaction.findUnique({where:{tx_ref:d}});if(e&&("delivered"!==e.status&&"paid"!==e.status&&await l._.transaction.update({where:{id:e.id},data:{status:"paid",paymentData:r}}),"data"===e.type&&e.planId)){if((await l._.transaction.updateMany({where:{id:e.id,OR:[{deliveryData:{equals:c.Prisma.DbNull}},{deliveryData:{equals:c.Prisma.JsonNull}}]},data:{deliveryData:{status:"processing",source:"webhook"}}})).count>0){let t=await l._.dataPlan.findUnique({where:{id:e.planId}});if(t){let r={network:u.Vi[t.network],mobile_number:e.phone,plan:Number(t.planId),Ported_number:!0},a=await (0,u.Ft)("/data/",r,d);a.success&&(!0===a.data.success||"successful"===a.data.Status||"delivered"===a.data.status||"successful"===a.data.status)?await l._.transaction.update({where:{id:e.id},data:{status:"delivered",deliveryData:a.data}}):await l._.transaction.update({where:{id:e.id},data:{deliveryData:{error:"Auto-delivery failed",response:a.data}}})}}else console.log(`[Webhook] Skipped delivery for ${d} - already processing/delivered.`)}}return n.Z.json({received:!0})}catch(e){return console.error("[Webhook] Error",e),n.Z.json({error:"Internal Error"},{status:200})}}let p=new s.AppRouteRouteModule({definition:{kind:o.x.APP_ROUTE,page:"/api/webhook/flutterwave/route",pathname:"/api/webhook/flutterwave",filename:"route",bundlePath:"app/api/webhook/flutterwave/route"},resolvedPagePath:"/workspaces/APP-Final/app/api/webhook/flutterwave/route.ts",nextConfigOutput:"standalone",userland:a}),{requestAsyncStorage:m,staticGenerationAsyncStorage:g,serverHooks:h,headerHooks:w,staticGenerationBailout:f}=p,v="/api/webhook/flutterwave/route";function y(){return(0,i.patchFetch)({serverHooks:h,staticGenerationAsyncStorage:g})}},313:(e,t,r)=>{"use strict";let a;r.d(t,{Vi:()=>g,Ft:()=>m});var s=r(8428),o=r(6489);let i={maxRetries:3,initialDelayMs:1e3,maxDelayMs:3e4,backoffMultiplier:2,shouldRetry:e=>!!(!e||"ECONNREFUSED"===e.code||"ETIMEDOUT"===e.code||e.response?.status>=500)};async function n(e,t={}){let r;let a={...i,...t},s=a.initialDelayMs;for(let t=0;t<=a.maxRetries;t++)try{return await e()}catch(e){if(r=e,t===a.maxRetries)break;if(!a.shouldRetry(e))throw e;await function(e){return new Promise(t=>setTimeout(t,e))}(s),s=Math.min(s*a.backoffMultiplier,a.maxDelayMs)}throw r}var l=r(8216);let u=process.env.AMIGO_BASE_URL||"https://amigo.ng/api/data/",c=process.env.AWS_PROXY_URL,d=process.env.AMIGO_API_KEY||"";if(c)try{a=new o.HttpsProxyAgent(c)}catch(e){console.error("Failed to initialize Proxy Agent",e)}let p=s.Z.create({httpsAgent:a,proxy:!1,headers:{"Content-Type":"application/json",Authorization:`Bearer ${d}`,Token:d,"X-API-Key":d,Accept:"application/json"},timeout:6e4});async function m(e,t,r){l.k.logExternalApiCall("AMIGO",u,"POST",0,0,{hasIdempotencyKey:!!r});try{let e=await n(async()=>{let e={};r&&(e["Idempotency-Key"]=r);let a=Date.now(),s=await p.post(u,t,{headers:e}),o=Date.now()-a;return l.k.logExternalApiCall("AMIGO",u,"POST",s.status,o),{success:!0,data:s.data,status:s.status}},{maxRetries:3,initialDelayMs:1e3,maxDelayMs:1e4,shouldRetry:e=>!!("ECONNREFUSED"===e.code||"ETIMEDOUT"===e.code||e.response?.status>=500)});return console.log(`[Amigo API] ✅ Success: ${e.status}`),e}catch(r){let e=r.response?.data?.message||r.message,t=r.response?.status||500;return l.k.logExternalApiCall("AMIGO",u,"POST",t,0,{error:e,retried:!0}),console.error(`[Amigo API] ❌ Failed: ${e}`),{success:!1,data:r.response?.data||{error:e},status:t}}}let g={MTN:1,GLO:2,AIRTEL:4,"9MOBILE":9}},8216:(e,t,r)=>{"use strict";var a;r.d(t,{k:()=>o}),function(e){e.DEBUG="DEBUG",e.INFO="INFO",e.WARN="WARN",e.ERROR="ERROR",e.CRITICAL="CRITICAL"}(a||(a={}));class s{formatLog(e){return JSON.stringify({...e,timestamp:new Date().toISOString()})}logApiRequest(e,t,r,a){let s=Date.now(),o=Math.random().toString(36).substr(2,9);return console.log(this.formatLog({timestamp:new Date().toISOString(),level:"INFO",service:e,action:t,userId:r,details:{...a,requestId:o,type:"REQUEST_START"}})),(a,i,n)=>{let l=Date.now()-s;console.log(this.formatLog({timestamp:new Date().toISOString(),level:a>=400?"ERROR":"INFO",service:e,action:t,userId:r,statusCode:a,duration:l,details:{...i,requestId:o,type:"REQUEST_END"},error:n?.message}))}}logTransaction(e,t,r,a,s){console.log(this.formatLog({timestamp:new Date().toISOString(),level:"SUCCESS"===a?"INFO":"WARN",service:"TRANSACTION",action:t,userId:e,details:{amount:r,status:a,...s}}))}logAuth(e,t,r,a){console.log(this.formatLog({timestamp:new Date().toISOString(),level:r?"INFO":"WARN",service:"AUTH",action:e,userId:t,details:{success:r,...a}}))}logSecurityEvent(e,t){console.log(this.formatLog({timestamp:new Date().toISOString(),level:"WARN",service:"SECURITY",action:e,details:t}))}logError(e,t,r,a){console.error(this.formatLog({timestamp:new Date().toISOString(),level:"ERROR",service:e,action:t,error:r.message,details:a}))}logCritical(e,t,r){console.error(this.formatLog({timestamp:new Date().toISOString(),level:"CRITICAL",service:"SYSTEM",action:e,error:t.message,details:r}))}logWebhook(e,t,r,a){console.log(this.formatLog({timestamp:new Date().toISOString(),level:"INFO",service:"WEBHOOK",action:e,details:{transactionId:t,status:r,...a}}))}logExternalApiCall(e,t,r,a,s,o){console.log(this.formatLog({timestamp:new Date().toISOString(),level:a>=400?"WARN":"DEBUG",service:`EXTERNAL_API_${e}`,action:`${r} ${t}`,statusCode:a,duration:s,details:o}))}logDatabaseOperation(e,t,r,a,s){console.log(this.formatLog({timestamp:new Date().toISOString(),level:a?"DEBUG":"ERROR",service:"DATABASE",action:`${e}_${t}`,duration:r,details:{success:a,...s}}))}}let o=new s},3214:(e,t,r)=>{"use strict";r.d(t,{_:()=>s});var a=r(3524);let s=globalThis.prisma||new a.PrismaClient({log:["query","error","warn"]})}};var t=require("../../../../webpack-runtime.js");t.C(e);var r=e=>t(t.s=e),a=t.X(0,[1638,6206,7901,8428,6489],()=>r(5245));module.exports=a})();