(()=>{var e={};e.id=5078,e.ids=[5078],e.modules={3524:e=>{"use strict";e.exports=require("@prisma/client")},517:e=>{"use strict";e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},9491:e=>{"use strict";e.exports=require("assert")},6113:e=>{"use strict";e.exports=require("crypto")},2361:e=>{"use strict";e.exports=require("events")},7147:e=>{"use strict";e.exports=require("fs")},3685:e=>{"use strict";e.exports=require("http")},5158:e=>{"use strict";e.exports=require("http2")},5687:e=>{"use strict";e.exports=require("https")},1808:e=>{"use strict";e.exports=require("net")},1017:e=>{"use strict";e.exports=require("path")},2781:e=>{"use strict";e.exports=require("stream")},4404:e=>{"use strict";e.exports=require("tls")},6224:e=>{"use strict";e.exports=require("tty")},7310:e=>{"use strict";e.exports=require("url")},3837:e=>{"use strict";e.exports=require("util")},9796:e=>{"use strict";e.exports=require("zlib")},7529:()=>{},8218:(e,t,a)=>{"use strict";a.r(t),a.d(t,{headerHooks:()=>v,originalPathname:()=>w,patchFetch:()=>x,requestAsyncStorage:()=>I,routeModule:()=>g,serverHooks:()=>f,staticGenerationAsyncStorage:()=>h,staticGenerationBailout:()=>y});var r={};a.r(r),a.d(r,{POST:()=>m});var i=a(5419),s=a(9108),n=a(9678),o=a(8070),l=a(3214),u=a(8272),c=a(313),d=a(2156),p=a(9856);async function m(e){try{let t=await e.json(),a=await (0,p.sQ)(t,p.Td);if(!a.valid){let e=a.errors.errors.map(e=>`${e.path.join(".")}: ${e.message}`);return o.Z.json({error:"Validation failed",details:e},{status:400})}let{agentId:r,agentPin:i,type:s,payload:n}=a.data,m=await l._.agent.findUnique({where:{id:r}});if(!m)return o.Z.json({error:"Agent not found"},{status:404});if(!await (0,d.vj)(i,m.pin))return console.error(`[PIN VERIFICATION FAILED] Agent: ${r}, Input PIN length: ${i.length}, Stored hash length: ${m.pin.length}`),o.Z.json({error:"Invalid PIN. Please check and try again."},{status:401});if(!m.isActive)return o.Z.json({error:"Agent Account Suspended"},{status:403});let g=0,I="",h={};if("data"===s&&n?.planId){let e=await l._.dataPlan.findUnique({where:{id:n.planId}});if(!e)return o.Z.json({error:"Invalid Plan"},{status:400});g=e.price,I=`Data: ${e.network} ${e.data}`,h={planId:e.id}}else if("ecommerce"===s&&n?.productId){let e=await l._.product.findUnique({where:{id:n.productId}});if(!e)return o.Z.json({error:"Invalid Product"},{status:400});if(g=e.price,I=e.name,h={productId:e.id},n.simId){let e=await l._.product.findUnique({where:{id:n.simId}});e&&(g+=e.price,I+=` + ${e.name}`)}}if(m.balance<g)return o.Z.json({error:"Insufficient Wallet Balance"},{status:402});let f=`AGENT-${s?.toUpperCase()||"TX"}-${Date.now()}`,v=await l._.$transaction(async e=>(await e.agent.update({where:{id:m.id},data:{balance:{decrement:g}}}),await e.transaction.create({data:{tx_ref:f,type:s,status:"paid",phone:n.phone,amount:g,agentId:m.id,customerName:n.name||m.firstName,deliveryState:n.state||"Agent Direct",idempotencyKey:(0,u.Z)(),...h,deliveryData:{method:"Agent Wallet",manifest:I}}})));if("data"===s){let e=await l._.dataPlan.findUnique({where:{id:n.planId}});if(e){let t={network:c.Vi[e.network],mobile_number:n.phone,plan:Number(e.planId),Ported_number:!0},a=await (0,c.Ft)("/data/",t,f),r=a.success&&(!0===a.data.success||"successful"===a.data.Status||"delivered"===a.data.status||"successful"===a.data.status);await l._.transaction.update({where:{id:v.id},data:{status:r?"delivered":"failed",deliveryData:{...v.deliveryData,amigo_response:a.data,status:r?"delivered":"failed"}}})}}let y=await l._.transaction.findUnique({where:{id:v.id},include:{product:!0,dataPlan:!0}});return o.Z.json({success:!0,transaction:y})}catch(e){return console.error("Agent Purchase Error:",e),o.Z.json({error:e.message||"Transaction failed"},{status:500})}}let g=new i.AppRouteRouteModule({definition:{kind:s.x.APP_ROUTE,page:"/api/agent/purchase/route",pathname:"/api/agent/purchase",filename:"route",bundlePath:"app/api/agent/purchase/route"},resolvedPagePath:"/workspaces/APP-Final/app/api/agent/purchase/route.ts",nextConfigOutput:"standalone",userland:r}),{requestAsyncStorage:I,staticGenerationAsyncStorage:h,serverHooks:f,headerHooks:v,staticGenerationBailout:y}=g,w="/api/agent/purchase/route";function x(){return(0,n.patchFetch)({serverHooks:f,staticGenerationAsyncStorage:h})}},313:(e,t,a)=>{"use strict";let r;a.d(t,{Vi:()=>g,Ft:()=>m});var i=a(8428),s=a(6489);let n={maxRetries:3,initialDelayMs:1e3,maxDelayMs:3e4,backoffMultiplier:2,shouldRetry:e=>!!(!e||"ECONNREFUSED"===e.code||"ETIMEDOUT"===e.code||e.response?.status>=500)};async function o(e,t={}){let a;let r={...n,...t},i=r.initialDelayMs;for(let t=0;t<=r.maxRetries;t++)try{return await e()}catch(e){if(a=e,t===r.maxRetries)break;if(!r.shouldRetry(e))throw e;await function(e){return new Promise(t=>setTimeout(t,e))}(i),i=Math.min(i*r.backoffMultiplier,r.maxDelayMs)}throw a}var l=a(8216);let u=process.env.AMIGO_BASE_URL||"https://amigo.ng/api/data/",c=process.env.AWS_PROXY_URL,d=process.env.AMIGO_API_KEY||"";if(c)try{r=new s.HttpsProxyAgent(c)}catch(e){console.error("Failed to initialize Proxy Agent",e)}let p=i.Z.create({httpsAgent:r,proxy:!1,headers:{"Content-Type":"application/json",Authorization:`Bearer ${d}`,Token:d,"X-API-Key":d,Accept:"application/json"},timeout:6e4});async function m(e,t,a){l.k.logExternalApiCall("AMIGO",u,"POST",0,0,{hasIdempotencyKey:!!a});try{let e=await o(async()=>{let e={};a&&(e["Idempotency-Key"]=a);let r=Date.now(),i=await p.post(u,t,{headers:e}),s=Date.now()-r;return l.k.logExternalApiCall("AMIGO",u,"POST",i.status,s),{success:!0,data:i.data,status:i.status}},{maxRetries:3,initialDelayMs:1e3,maxDelayMs:1e4,shouldRetry:e=>!!("ECONNREFUSED"===e.code||"ETIMEDOUT"===e.code||e.response?.status>=500)});return console.log(`[Amigo API] ✅ Success: ${e.status}`),e}catch(a){let e=a.response?.data?.message||a.message,t=a.response?.status||500;return l.k.logExternalApiCall("AMIGO",u,"POST",t,0,{error:e,retried:!0}),console.error(`[Amigo API] ❌ Failed: ${e}`),{success:!1,data:a.response?.data||{error:e},status:t}}}let g={MTN:1,GLO:2,AIRTEL:4,"9MOBILE":9}},8216:(e,t,a)=>{"use strict";var r;a.d(t,{k:()=>s}),function(e){e.DEBUG="DEBUG",e.INFO="INFO",e.WARN="WARN",e.ERROR="ERROR",e.CRITICAL="CRITICAL"}(r||(r={}));class i{formatLog(e){return JSON.stringify({...e,timestamp:new Date().toISOString()})}logApiRequest(e,t,a,r){let i=Date.now(),s=Math.random().toString(36).substr(2,9);return console.log(this.formatLog({timestamp:new Date().toISOString(),level:"INFO",service:e,action:t,userId:a,details:{...r,requestId:s,type:"REQUEST_START"}})),(r,n,o)=>{let l=Date.now()-i;console.log(this.formatLog({timestamp:new Date().toISOString(),level:r>=400?"ERROR":"INFO",service:e,action:t,userId:a,statusCode:r,duration:l,details:{...n,requestId:s,type:"REQUEST_END"},error:o?.message}))}}logTransaction(e,t,a,r,i){console.log(this.formatLog({timestamp:new Date().toISOString(),level:"SUCCESS"===r?"INFO":"WARN",service:"TRANSACTION",action:t,userId:e,details:{amount:a,status:r,...i}}))}logAuth(e,t,a,r){console.log(this.formatLog({timestamp:new Date().toISOString(),level:a?"INFO":"WARN",service:"AUTH",action:e,userId:t,details:{success:a,...r}}))}logSecurityEvent(e,t){console.log(this.formatLog({timestamp:new Date().toISOString(),level:"WARN",service:"SECURITY",action:e,details:t}))}logError(e,t,a,r){console.error(this.formatLog({timestamp:new Date().toISOString(),level:"ERROR",service:e,action:t,error:a.message,details:r}))}logCritical(e,t,a){console.error(this.formatLog({timestamp:new Date().toISOString(),level:"CRITICAL",service:"SYSTEM",action:e,error:t.message,details:a}))}logWebhook(e,t,a,r){console.log(this.formatLog({timestamp:new Date().toISOString(),level:"INFO",service:"WEBHOOK",action:e,details:{transactionId:t,status:a,...r}}))}logExternalApiCall(e,t,a,r,i,s){console.log(this.formatLog({timestamp:new Date().toISOString(),level:r>=400?"WARN":"DEBUG",service:`EXTERNAL_API_${e}`,action:`${a} ${t}`,statusCode:r,duration:i,details:s}))}logDatabaseOperation(e,t,a,r,i){console.log(this.formatLog({timestamp:new Date().toISOString(),level:r?"DEBUG":"ERROR",service:"DATABASE",action:`${e}_${t}`,duration:a,details:{success:r,...i}}))}}let s=new i},3214:(e,t,a)=>{"use strict";a.d(t,{_:()=>i});var r=a(3524);let i=globalThis.prisma||new r.PrismaClient({log:["query","error","warn"]})},2156:(e,t,a)=>{"use strict";a.d(t,{vj:()=>s,xM:()=>i});var r=a(5050);async function i(e){try{let t=await r.ZP.genSalt(10);return await r.ZP.hash(e,t)}catch(e){throw console.error("Error hashing PIN:",e),Error("Failed to hash PIN")}}async function s(e,t){try{return await r.ZP.compare(e,t)}catch(e){return console.error("Error verifying PIN:",e),!1}}},9856:(e,t,a)=>{"use strict";a.d(t,{A0:()=>s,Td:()=>l,ZB:()=>o,g1:()=>n,sQ:()=>u});var r=a(5252),i=a(2178);let s=r.Ry({firstName:r.Z_().min(2,"First name must be at least 2 characters").max(50),lastName:r.Z_().min(2,"Last name must be at least 2 characters").max(50),phone:r.Z_().regex(/^[0-9]{10,11}$/,"Invalid phone number"),pin:r.Z_().regex(/^[0-9]{4}$/,"PIN must be exactly 4 digits")}),n=r.Ry({phone:r.Z_().regex(/^[0-9]{10,11}$/,"Invalid phone number"),pin:r.Z_().regex(/^[0-9]{4}$/,"PIN must be exactly 4 digits")});r.Ry({tx_ref:r.Z_().min(1,"Transaction reference required")});let o=r.Ry({productId:r.Z_().min(1,"Product ID required"),phone:r.Z_().regex(/^[0-9]{10,11}$/,"Invalid phone number"),name:r.Z_().min(2,"Name required").max(100),state:r.Z_().min(2,"State required").max(100),simId:r.Z_().optional()});r.Ry({phone:r.Z_().regex(/^[0-9]{10,11}$/,"Invalid phone number"),network:r.Km(["MTN","AIRTEL","GLO"]),planId:r.Rx().positive("Invalid plan ID"),agentId:r.Z_().uuid("Invalid agent ID").optional(),agentPin:r.Z_().regex(/^[0-9]{4}$/,"PIN must be exactly 4 digits").optional()}),r.Ry({amount:r.Rx().positive("Amount must be positive"),phone:r.Z_().regex(/^[0-9]{10,11}$/,"Invalid phone number"),agentId:r.Z_().uuid("Invalid agent ID"),agentPin:r.Z_().regex(/^[0-9]{4}$/,"PIN must be exactly 4 digits")});let l=r.Ry({agentId:r.Z_().uuid("Invalid agent ID"),agentPin:r.Z_().regex(/^[0-9]{4}$/,"PIN must be exactly 4 digits"),type:r.Km(["data","ecommerce"]),payload:r.Ry({planId:r.Z_().optional(),productId:r.Z_().optional(),simId:r.Z_().optional(),phone:r.Z_().regex(/^[0-9]{10,11}$/,"Invalid phone number").optional(),name:r.Z_().min(2).max(100).optional(),state:r.Z_().min(2).max(100).optional()}).strict()});r.Ry({phone:r.Z_().regex(/^[0-9]{10,11}$/,"Invalid phone number"),message:r.Z_().min(10,"Message must be at least 10 characters").max(1e3),subject:r.Z_().optional()}),r.Ry({adminPassword:r.Z_().min(6,"Invalid password")}),r.Ry({agentId:r.Z_().uuid("Invalid agent ID"),amount:r.Rx().positive("Amount must be positive"),reason:r.Z_().optional(),adminPassword:r.Z_().min(6,"Invalid password")});let u=async(e,t)=>{try{let a=await t.parseAsync(e);return{valid:!0,data:a}}catch(e){if(e instanceof i.jm)return{valid:!1,errors:e};throw e}}},8272:(e,t,a)=>{"use strict";a.d(t,{Z:()=>u});var r=a(6113),i=a.n(r);let s={randomUUID:i().randomUUID},n=new Uint8Array(256),o=n.length,l=[];for(let e=0;e<256;++e)l.push((e+256).toString(16).slice(1));let u=function(e,t,a){if(s.randomUUID&&!t&&!e)return s.randomUUID();let r=(e=e||{}).random||(e.rng||function(){return o>n.length-16&&(i().randomFillSync(n),o=0),n.slice(o,o+=16)})();if(r[6]=15&r[6]|64,r[8]=63&r[8]|128,t){a=a||0;for(let e=0;e<16;++e)t[a+e]=r[e];return t}return function(e,t=0){return l[e[t+0]]+l[e[t+1]]+l[e[t+2]]+l[e[t+3]]+"-"+l[e[t+4]]+l[e[t+5]]+"-"+l[e[t+6]]+l[e[t+7]]+"-"+l[e[t+8]]+l[e[t+9]]+"-"+l[e[t+10]]+l[e[t+11]]+l[e[t+12]]+l[e[t+13]]+l[e[t+14]]+l[e[t+15]]}(r)}}};var t=require("../../../../webpack-runtime.js");t.C(e);var a=e=>t(t.s=e),r=t.X(0,[1638,6206,7901,8428,6489,5252,7529],()=>a(8218));module.exports=r})();